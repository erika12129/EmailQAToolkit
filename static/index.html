<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email QA Automation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .file-input-container {
            margin-bottom: 20px;
        }
        .button {
            background-color: #4299e1;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        .button:hover {
            background-color: #3182ce;
        }
        .button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .error {
            background-color: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed; /* Enable fixed table layout for better width control */
        }
        th, td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            word-break: break-word; /* Allow words to break */
            overflow-wrap: break-word; /* Modern browsers */
        }
        th {
            background-color: #edf2f7;
        }
        /* Set column widths for link results table */
        #links-results th:nth-child(1) { width: 10%; } /* Link Text */
        #links-results th:nth-child(2) { width: 30%; } /* URL - give space for long URLs */
        #links-results th:nth-child(3) { width: 25%; } /* Redirected To - for localized domains */
        #links-results th:nth-child(4) { width: 10%; } /* Status */
        #links-results th:nth-child(5) { width: 25%; } /* Issues */
        .pass {
            color: #38a169;
        }
        .fail {
            color: #e53e3e;
        }
        .hidden {
            display: none;
        }
        .file-name {
            margin-top: 5px;
            font-style: italic;
        }
        .results-container {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        .text-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            background-color: #f7fafc;
        }
        .text-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
            background-color: #fff;
        }
        #requirements-form {
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a5568;
        }
        .form-group-radio {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-container {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-label {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Email QA Automation</h1>
        
        <div class="mb-4 p-4" style="background-color: #ebf8ff; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem;">
            <p style="margin-bottom: 0.5rem;">
                This tool validates HTML emails against predefined requirements for metadata and UTM parameters.
            </p>
            <div style="margin-top: 0.5rem;">
                <span style="font-weight: 600;">Need examples?</span> 
                <a href="/static/sample_email.html" download style="color: #4299e1; margin-left: 0.5rem;">
                    Download Sample Email HTML
                </a>
                <a href="/static/sample_requirements.json" download style="color: #4299e1; margin-left: 1rem;">
                    Download Sample Requirements JSON
                </a>
            </div>
        </div>
        
        <form id="qa-form">
            <div class="file-input-container">
                <label>Upload Email HTML:</label>
                <input type="file" accept=".html" id="email-file" />
                <div id="email-file-name" class="file-name"></div>
            </div>
            
            <div>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; font-size: 16px;">Email Requirements</h3>
                    <button type="button" id="toggle-advanced" style="margin-left: 10px; font-size: 12px; padding: 4px 8px; background-color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                        Switch to JSON
                    </button>
                </div>
                
                <!-- Form Fields for Requirements -->
                <div id="requirements-form">
                    <!-- Email Type Selection -->
                    <div class="form-section">
                        <h4 class="section-title">Email Type</h4>
                        <div class="form-group-radio">
                            <label class="radio-container">
                                <input type="radio" name="email-type" id="promotional" value="promotional" checked>
                                <span class="radio-label">Promotional</span>
                            </label>
                            <label class="radio-container">
                                <input type="radio" name="email-type" id="transactional" value="transactional">
                                <span class="radio-label">Transactional</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Sender Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">Sender Information</h4>
                        <div class="form-group">
                            <label for="sender-name">Sender From Name:</label>
                            <input type="text" id="sender-name" class="text-input" placeholder="Company Name" value="Company Name">
                        </div>
                        
                        <div class="form-group">
                            <label for="sender-email">Sender From Email Address:</label>
                            <input type="email" id="sender-email" class="text-input" placeholder="marketing@company.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="reply-email">Reply Email Address:</label>
                            <input type="email" id="reply-email" class="text-input" placeholder="support@company.com">
                        </div>
                    </div>
                    
                    <!-- Locale Section -->
                    <div class="form-section">
                        <h4 class="section-title">Locale</h4>
                        <div class="form-group">
                            <label for="country">Country:</label>
                            <input type="text" id="country" class="text-input" placeholder="United States">
                        </div>
                        
                        <div class="form-group">
                            <label for="language">Language:</label>
                            <input type="text" id="language" class="text-input" placeholder="English">
                        </div>
                    </div>
                    
                    <!-- Email Content Section -->
                    <div class="form-section">
                        <h4 class="section-title">Email Content</h4>
                        <div class="form-group">
                            <label for="subject">Subject Line:</label>
                            <input type="text" id="subject" class="text-input" placeholder="Special Discount - 25% Off">
                        </div>
                        
                        <div class="form-group">
                            <label for="preheader">Preheader Text:</label>
                            <input type="text" id="preheader" class="text-input" placeholder="Limited time offer: 25% discount on all products!">
                        </div>
                    </div>
                    
                    <!-- UTM Parameters Section -->
                    <div class="form-section">
                        <h4 class="section-title">UTM Parameters</h4>
                        <div class="form-group">
                            <label for="utm-medium">UTM Medium:</label>
                            <input type="text" id="utm-medium" class="text-input" placeholder="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-source">UTM Source:</label>
                            <input type="text" id="utm-source" class="text-input" placeholder="marketing">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-campaign">UTM Campaign:</label>
                            <input type="text" id="utm-campaign" class="text-input" placeholder="special_offer">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-content">UTM Content:</label>
                            <input type="text" id="utm-content" class="text-input" placeholder="summer-sale-2025">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-country">Country Code:</label>
                            <input type="text" id="utm-country" class="text-input" placeholder="us">
                        </div>
                        
                        <div class="form-group">
                            <label for="webtrends">Webtrends:</label>
                            <input type="text" id="webtrends" class="text-input" placeholder="summer-promo">
                        </div>
                    </div>
                </div>
                
                <!-- JSON Upload (hidden by default) -->
                <div id="json-upload-container" class="hidden">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <button type="button" id="toggle-json-input" style="font-size: 12px; padding: 4px 8px; background-color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Switch to JSON Editor
                        </button>
                    </div>
                    
                    <div id="json-file-container">
                        <div class="file-input-container">
                            <label>Upload Requirements JSON:</label>
                            <input type="file" accept=".json" id="req-file" />
                            <div id="req-file-name" class="file-name"></div>
                        </div>
                    </div>
                    
                    <div id="json-editor-container" class="hidden">
                        <div style="margin-bottom: 10px;">
                            <label for="json-textarea">Edit Requirements JSON:</label>
                            <div style="display: flex; justify-content: flex-end; margin: 5px 0;">
                                <button type="button" id="validate-json" style="font-size: 12px; padding: 4px 8px; background-color: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Validate JSON
                                </button>
                            </div>
                            <textarea id="json-textarea" rows="15" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;"></textarea>
                            <div id="json-validation-message" style="margin-top: 5px; font-size: 14px;"></div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <button type="button" id="load-sample-json" style="font-size: 12px; padding: 4px 8px; background-color: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Load Sample JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error-message" class="error hidden"></div>
            
            <!-- Production Mode Option -->
            <div class="p-4 mt-3 bg-gray-50 rounded-lg border border-gray-100" style="margin-bottom: 15px; padding: 10px; background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                <label style="display: flex; align-items: center; font-size: 14px; font-weight: 500; color: #4b5563;">
                    <input type="checkbox" id="production-mode" style="margin-right: 8px;" checked>
                    Production Mode (disable localhost redirects)
                </label>
                <p style="margin-top: 4px; font-size: 12px; color: #6b7280;">
                    Enabled by default. This prevents redirects to localhost and validates links directly against production domains.
                </p>
            </div>
            
            <button type="submit" class="button" id="submit-button">Run QA</button>
        </form>
        
        <div id="loading-message" class="hidden">Running QA checks...</div>
        
        <div id="results-container" class="results-container hidden">
            <h2>QA Results</h2>
            
            <h3>Metadata</h3>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Expected</th>
                        <th>Actual</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="metadata-results">
                    <!-- Results will be inserted here -->
                </tbody>
            </table>
            
            <h3>Links</h3>
            <table>
                <thead>
                    <tr>
                        <th>Link Source</th>
                        <th>URL</th>
                        <th>Redirected To</th>
                        <th>Status</th>
                        <th>Product Table Detection</th>
                        <th>Issues</th>
                    </tr>
                </thead>
                <tbody id="links-results">
                    <!-- Results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Helper function to show/hide elements
        function showElement(element) {
            element.classList.remove('hidden');
        }
        
        function hideElement(element) {
            element.classList.add('hidden');
        }
        
        // Form elements
        const form = document.getElementById('qa-form');
        const emailFileInput = document.getElementById('email-file');
        const reqFileInput = document.getElementById('req-file');
        const emailFileName = document.getElementById('email-file-name');
        const reqFileName = document.getElementById('req-file-name');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');
        const loadingMessage = document.getElementById('loading-message');
        const resultsContainer = document.getElementById('results-container');
        const metadataResults = document.getElementById('metadata-results');
        const linksResults = document.getElementById('links-results');
        
        // Form fields for requirements
        const requirementsForm = document.getElementById('requirements-form');
        const jsonUploadContainer = document.getElementById('json-upload-container');
        const toggleButton = document.getElementById('toggle-advanced');
        
        // JSON editor elements
        const jsonFileContainer = document.getElementById('json-file-container');
        const jsonEditorContainer = document.getElementById('json-editor-container');
        const toggleJsonInputButton = document.getElementById('toggle-json-input');
        const jsonTextarea = document.getElementById('json-textarea');
        const validateJsonButton = document.getElementById('validate-json');
        const jsonValidationMessage = document.getElementById('json-validation-message');
        const loadSampleJsonButton = document.getElementById('load-sample-json');
        
        // Email type radio buttons
        const promotionalRadio = document.getElementById('promotional');
        const transactionalRadio = document.getElementById('transactional');
        
        // Form fields - Sender information
        const senderNameInput = document.getElementById('sender-name');
        const senderEmailInput = document.getElementById('sender-email');
        const replyEmailInput = document.getElementById('reply-email');
        
        // Form fields - Email content
        const subjectInput = document.getElementById('subject');
        const preheaderInput = document.getElementById('preheader');
        const countryInput = document.getElementById('country');
        const languageInput = document.getElementById('language');
        
        // Form fields - UTM parameters
        const utmMediumInput = document.getElementById('utm-medium');
        const utmSourceInput = document.getElementById('utm-source');
        const utmCampaignInput = document.getElementById('utm-campaign');
        const utmContentInput = document.getElementById('utm-content');
        const utmCountryInput = document.getElementById('utm-country');
        const webtrendsInput = document.getElementById('webtrends');
        
        let useJsonUpload = false; // Start with form fields by default
        
        // Set default values based on email type
        function setDefaultsByEmailType() {
            if (promotionalRadio.checked) {
                // Promotional email defaults
                utmMediumInput.value = utmMediumInput.value || 'email';
                utmSourceInput.value = utmSourceInput.value || 'marketing';
                utmCampaignInput.placeholder = 'promotional_campaign';
                // Clear any specific placeholder for sender email if empty
                if (!senderEmailInput.value) {
                    senderEmailInput.placeholder = 'marketing@company.com';
                }
            } else {
                // Transactional email defaults
                utmMediumInput.value = utmMediumInput.value || 'email';
                utmSourceInput.value = utmSourceInput.value || 'transactional';
                utmCampaignInput.placeholder = 'receipt_notification';
                // Clear any specific placeholder for sender email if empty
                if (!senderEmailInput.value) {
                    senderEmailInput.placeholder = 'noreply@company.com';
                }
            }
        }
        
        // Initialize defaults
        setDefaultsByEmailType();
        
        // Listen for changes to email type
        promotionalRadio.addEventListener('change', setDefaultsByEmailType);
        transactionalRadio.addEventListener('change', setDefaultsByEmailType);
        
        // Toggle between form fields and JSON upload
        toggleButton.addEventListener('click', function() {
            useJsonUpload = !useJsonUpload;
            
            if (useJsonUpload) {
                hideElement(requirementsForm);
                showElement(jsonUploadContainer);
                toggleButton.textContent = 'Switch to Form Fields';
            } else {
                showElement(requirementsForm);
                hideElement(jsonUploadContainer);
                toggleButton.textContent = 'Switch to JSON';
            }
        });
        
        // Update file name display
        emailFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                emailFileName.textContent = this.files[0].name;
            } else {
                emailFileName.textContent = '';
            }
            hideElement(errorMessage);
        });
        
        reqFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                reqFileName.textContent = this.files[0].name;
            } else {
                reqFileName.textContent = '';
            }
            hideElement(errorMessage);
        });
        
        // Toggle between JSON file upload and JSON textarea
        let useJsonTextarea = false;
        toggleJsonInputButton.addEventListener('click', function() {
            useJsonTextarea = !useJsonTextarea;
            
            if (useJsonTextarea) {
                hideElement(jsonFileContainer);
                showElement(jsonEditorContainer);
                toggleJsonInputButton.textContent = 'Switch to File Upload';
            } else {
                showElement(jsonFileContainer);
                hideElement(jsonEditorContainer);
                toggleJsonInputButton.textContent = 'Switch to JSON Editor';
            }
        });
        
        // JSON validation function
        function validateJson(jsonString) {
            try {
                const result = JSON.parse(jsonString);
                
                // Check for required fields
                const missing = [];
                if (!result.sender_address) missing.push('sender_address');
                if (!result.subject) missing.push('subject');
                if (!result.preheader) missing.push('preheader');
                
                if (missing.length > 0) {
                    return {
                        valid: false,
                        message: `Missing required fields: ${missing.join(', ')}`
                    };
                }
                
                return {
                    valid: true,
                    message: 'JSON is valid!',
                    json: result
                };
            } catch (e) {
                // Format the error message to be more helpful
                let message = e.message;
                
                // Check for common JSON syntax errors
                if (message.includes('Unexpected token')) {
                    message += '. Check for missing or misplaced quotation marks, commas, or braces.';
                } else if (message.includes('Unexpected end of JSON input')) {
                    message += '. You might be missing a closing brace or bracket.';
                }
                
                return {
                    valid: false,
                    message: message
                };
            }
        }
        
        // Validate JSON button click handler
        validateJsonButton.addEventListener('click', function() {
            const result = validateJson(jsonTextarea.value);
            
            jsonValidationMessage.textContent = result.message;
            jsonValidationMessage.style.color = result.valid ? '#48bb78' : '#e53e3e';
            
            if (result.valid) {
                // Format the JSON for better readability
                jsonTextarea.value = JSON.stringify(result.json, null, 2);
            }
        });
        
        // Load sample JSON
        loadSampleJsonButton.addEventListener('click', function() {
            // Add dropdown menu for sample selection
            if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('sample-selector')) {
                const sampleSelector = document.createElement('div');
                sampleSelector.classList.add('sample-selector');
                sampleSelector.style.position = 'absolute';
                sampleSelector.style.zIndex = '100';
                sampleSelector.style.backgroundColor = 'white';
                sampleSelector.style.border = '1px solid #e2e8f0';
                sampleSelector.style.borderRadius = '4px';
                sampleSelector.style.padding = '8px';
                sampleSelector.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                sampleSelector.style.marginTop = '5px';
                
                // Add sample options
                const samples = [
                    { name: 'Standard Requirements', path: '/attached_assets/sample_requirements.json' },
                    { name: 'UTM Campaign Example', path: '/attached_assets/utm_campaign_sample.json' }
                ];
                
                samples.forEach(sample => {
                    const option = document.createElement('div');
                    option.textContent = sample.name;
                    option.style.padding = '8px';
                    option.style.cursor = 'pointer';
                    option.style.borderRadius = '4px';
                    option.addEventListener('mouseover', () => {
                        option.style.backgroundColor = '#f0f5ff';
                    });
                    option.addEventListener('mouseout', () => {
                        option.style.backgroundColor = 'transparent';
                    });
                    option.addEventListener('click', () => {
                        // Load the selected sample
                        fetch(sample.path)
                            .then(response => response.json())
                            .then(data => {
                                // Format and display in the textarea
                                jsonTextarea.value = JSON.stringify(data, null, 2);
                                jsonValidationMessage.textContent = `${sample.name} loaded! `;
                                
                                // Add note for UTM campaign example
                                if (sample.name === 'UTM Campaign Example') {
                                    const noteLink = document.createElement('a');
                                    noteLink.href = '/attached_assets/utm_validation_guide.md';
                                    noteLink.target = '_blank';
                                    noteLink.textContent = 'View UTM Campaign validation guide';
                                    noteLink.style.color = '#4299e1';
                                    noteLink.style.textDecoration = 'underline';
                                    jsonValidationMessage.appendChild(noteLink);
                                }
                                
                                jsonValidationMessage.style.color = '#48bb78';
                                
                                // Hide the selector
                                sampleSelector.remove();
                            })
                            .catch(error => {
                                jsonValidationMessage.textContent = `Failed to load ${sample.name}.`;
                                jsonValidationMessage.style.color = '#e53e3e';
                                sampleSelector.remove();
                            });
                    });
                    sampleSelector.appendChild(option);
                });
                
                // Add close option
                const closeOption = document.createElement('div');
                closeOption.textContent = 'Cancel';
                closeOption.style.padding = '8px';
                closeOption.style.cursor = 'pointer';
                closeOption.style.borderTop = '1px solid #e2e8f0';
                closeOption.style.marginTop = '5px';
                closeOption.style.borderRadius = '4px';
                closeOption.addEventListener('mouseover', () => {
                    closeOption.style.backgroundColor = '#f0f5ff';
                });
                closeOption.addEventListener('mouseout', () => {
                    closeOption.style.backgroundColor = 'transparent';
                });
                closeOption.addEventListener('click', () => {
                    sampleSelector.remove();
                });
                sampleSelector.appendChild(closeOption);
                
                this.after(sampleSelector);
                
                // Close the selector if clicked outside
                document.addEventListener('click', function clickOutside(e) {
                    if (!sampleSelector.contains(e.target) && e.target !== loadSampleJsonButton) {
                        sampleSelector.remove();
                        document.removeEventListener('click', clickOutside);
                    }
                });
            } else {
                // Toggle visibility if selector already exists
                this.nextElementSibling.remove();
            }
        });
        
        // Form submission
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate email file input
            if (!emailFileInput.files.length) {
                errorMessage.textContent = 'Please upload an email HTML file.';
                showElement(errorMessage);
                return;
            }
            
            // Start loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Running QA...';
            hideElement(errorMessage);
            hideElement(resultsContainer);
            showElement(loadingMessage);
            
            // Create form data
            const formData = new FormData();
            formData.append('email', emailFileInput.files[0]);
            
            if (useJsonUpload) {
                let jsonContent;
                
                // Check if we're using the JSON editor or file upload
                if (!useJsonTextarea) {
                    // Check if JSON file upload is provided
                    if (!reqFileInput.files.length) {
                        errorMessage.textContent = 'Please upload a requirements JSON file.';
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                    
                    formData.append('requirements', reqFileInput.files[0]);
                } else {
                    // Check if JSON text is provided and valid
                    if (!jsonTextarea.value.trim()) {
                        errorMessage.textContent = 'Please enter JSON requirements in the editor.';
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                    
                    try {
                        // Validate JSON structure
                        jsonContent = JSON.parse(jsonTextarea.value);
                        
                        // Basic requirements validation
                        if (!jsonContent.sender_address || !jsonContent.subject || !jsonContent.preheader) {
                            errorMessage.textContent = 'JSON requirements must include sender_address, subject, and preheader fields.';
                            showElement(errorMessage);
                            submitButton.disabled = false;
                            submitButton.textContent = 'Run QA';
                            hideElement(loadingMessage);
                            return;
                        }
                        
                        // Convert to JSON file
                        const requirementsBlob = new Blob([jsonTextarea.value], { type: 'application/json' });
                        const requirementsFile = new File([requirementsBlob], 'editor_requirements.json', { type: 'application/json' });
                        formData.append('requirements', requirementsFile);
                    } catch (e) {
                        errorMessage.textContent = 'Invalid JSON: ' + e.message;
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                }
            } else {
                // Validate form fields
                if (!senderEmailInput.value || !subjectInput.value || !preheaderInput.value) {
                    errorMessage.textContent = 'Please fill in the required fields (Sender Email, Subject Line, and Preheader).';
                    showElement(errorMessage);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Run QA';
                    hideElement(loadingMessage);
                    return;
                }
                
                // Create requirements JSON from form fields
                const requirementsObj = {
                    sender_name: senderNameInput.value,
                    sender_address: senderEmailInput.value,
                    reply_address: replyEmailInput.value,
                    subject: subjectInput.value,
                    preheader: preheaderInput.value,
                    country: countryInput.value,
                    language: languageInput.value,
                    email_type: promotionalRadio.checked ? 'promotional' : 'transactional',
                    utm_parameters: {}
                };
                
                // Add UTM parameters if provided
                if (utmMediumInput.value) requirementsObj.utm_parameters.utm_medium = utmMediumInput.value;
                if (utmSourceInput.value) requirementsObj.utm_parameters.utm_source = utmSourceInput.value;
                if (utmCampaignInput.value) requirementsObj.utm_parameters.utm_campaign = utmCampaignInput.value;
                if (utmContentInput.value) requirementsObj.utm_parameters.utm_content = utmContentInput.value;
                if (utmCountryInput.value) requirementsObj.utm_parameters.country = utmCountryInput.value;
                if (webtrendsInput.value) requirementsObj.utm_parameters.webtrends = webtrendsInput.value;
                
                // Convert to JSON and create a file
                const requirementsBlob = new Blob([JSON.stringify(requirementsObj, null, 2)], { type: 'application/json' });
                const requirementsFile = new File([requirementsBlob], 'generated_requirements.json', { type: 'application/json' });
                
                formData.append('requirements', requirementsFile);
            }
            
            // Add production mode parameter if checked
            const productionModeCheckbox = document.getElementById('production-mode');
            if (productionModeCheckbox && productionModeCheckbox.checked) {
                formData.append('force_production', 'true');
            }
            
            // Submit the form
            fetch('/run-qa', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            // Try to parse the response as JSON
                            const data = JSON.parse(text);
                            throw new Error(data.detail || 'Failed to process QA');
                        } catch (e) {
                            // If JSON parsing fails, it's likely HTML or another format
                            console.error('Server returned non-JSON response:', text.substring(0, 200) + '...');
                            throw new Error('Server returned invalid format. Please check console for details.');
                        }
                    });
                }
                // For successful responses, first get the raw text
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        return JSON.parse(text);
                    } catch (e) {
                        // If parsing fails, show error with some context from the response
                        console.error('Failed to parse successful response as JSON:', text.substring(0, 200) + '...');
                        throw new Error('Server returned invalid JSON. Please check console for details.');
                    }
                });
            })
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('QA error:', error);
                if (error.message && error.message.includes('Unexpected token')) {
                    errorMessage.textContent = 'Invalid response format. Please refresh the page and try again or check console for details.';
                } else {
                    errorMessage.textContent = error.message || 'An error occurred while processing the request.';
                }
                showElement(errorMessage);
            })
            .finally(() => {
                // End loading state
                submitButton.disabled = false;
                submitButton.textContent = 'Run QA';
                hideElement(loadingMessage);
            });
        });
        
        // Display QA results
        function displayResults(data) {
            // Clear previous results
            metadataResults.innerHTML = '';
            linksResults.innerHTML = '';
            
            // Map field names for display
            const fieldNameMap = {
                'sender': 'sender_address', 
                'sender_address': 'sender_address',
                'sender_name': 'sender_name',
                'reply_to': 'reply_address',
                'reply_address': 'reply_address'
            };
            
            // Get expected metadata values from original form inputs
            let allMetadata = [...data.metadata];
            
            // Make sure we have sender_name and reply_address in the results
            const hasField = (field) => allMetadata.some(item => item.field === field);
            
            if (!hasField('sender_name') && senderNameInput.value) {
                allMetadata.push({
                    field: 'sender_name',
                    expected: senderNameInput.value,
                    actual: 'Not found',
                    status: 'FAIL'
                });
            }
            
            if (!hasField('sender') && !hasField('sender_address') && senderEmailInput.value) {
                allMetadata.push({
                    field: 'sender_address',
                    expected: senderEmailInput.value,
                    actual: 'Not found',
                    status: 'FAIL'
                });
            }
            
            if (!hasField('reply_to') && !hasField('reply_address') && replyEmailInput.value) {
                allMetadata.push({
                    field: 'reply_address',
                    expected: replyEmailInput.value,
                    actual: 'Not found',
                    status: 'FAIL'
                });
            }
            
            // Display metadata results
            allMetadata.forEach(item => {
                const row = document.createElement('tr');
                
                const fieldCell = document.createElement('td');
                // Use the mapped field name if available, otherwise use the original field name
                fieldCell.textContent = fieldNameMap[item.field] || item.field;
                row.appendChild(fieldCell);
                
                const expectedCell = document.createElement('td');
                expectedCell.textContent = item.expected;
                row.appendChild(expectedCell);
                
                const actualCell = document.createElement('td');
                actualCell.textContent = item.actual;
                
                if (item.details) {
                    const detailsElement = document.createElement('div');
                    detailsElement.innerHTML = `<em>${item.details}</em>`;
                    detailsElement.style.fontSize = 'smaller';
                    detailsElement.style.marginTop = '5px';
                    actualCell.appendChild(detailsElement);
                }
                
                row.appendChild(actualCell);
                
                const statusCell = document.createElement('td');
                statusCell.textContent = item.status;
                statusCell.className = item.status === 'PASS' ? 'pass' : 'fail';
                row.appendChild(statusCell);
                
                metadataResults.appendChild(row);
            });
            
            // Display links results
            data.links.forEach(item => {
                const row = document.createElement('tr');
                
                // Link Source Cell
                const sourceCell = document.createElement('td');
                
                // Check if this is an image link
                if (item.is_image_link && item.image_src) {
                    // Create a container for the thumbnail and text
                    const container = document.createElement('div');
                    container.style.display = 'flex';
                    container.style.alignItems = 'center';
                    container.style.gap = '8px';
                    
                    // Create thumbnail
                    const thumbnail = document.createElement('img');
                    thumbnail.src = item.image_src;
                    thumbnail.alt = item.image_alt || 'Image';
                    thumbnail.style.maxWidth = '40px';
                    thumbnail.style.maxHeight = '40px';
                    thumbnail.style.border = '1px solid #e2e8f0';
                    thumbnail.style.borderRadius = '2px';
                    container.appendChild(thumbnail);
                    
                    // Add the link text or image alt
                    const textSpan = document.createElement('span');
                    textSpan.textContent = item.image_alt || item.link_text || '[Image Link]';
                    container.appendChild(textSpan);
                    
                    sourceCell.appendChild(container);
                } else {
                    // Just show the link text for regular links
                    sourceCell.textContent = item.link_text || '[No text]';
                }
                
                row.appendChild(sourceCell);
                
                // Original URL Cell
                const urlCell = document.createElement('td');
                urlCell.style.wordBreak = 'break-word'; // Allow URLs to wrap
                urlCell.style.maxWidth = '250px'; // Set a max width to encourage wrapping
                
                const link = document.createElement('a');
                link.href = item.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = item.url; // Display the full URL
                urlCell.appendChild(link);
                row.appendChild(urlCell);
                
                // Redirected URL Cell (new)
                const redirectedCell = document.createElement('td');
                redirectedCell.style.wordBreak = 'break-word'; // Allow URLs to wrap
                redirectedCell.style.maxWidth = '250px'; // Set a max width to encourage wrapping
                
                if (item.redirected_to) {
                    const redirectedLink = document.createElement('a');
                    redirectedLink.href = item.redirected_to;
                    redirectedLink.target = '_blank';
                    redirectedLink.rel = 'noopener noreferrer';
                    redirectedLink.textContent = item.redirected_to;
                    redirectedCell.appendChild(redirectedLink);
                    
                    // Add a visual indicator for localtest.me domains that were redirected
                    if (item.url.includes('localtest.me')) {
                        const localeIndicator = document.createElement('div');
                        localeIndicator.style.fontSize = '12px';
                        localeIndicator.style.marginTop = '4px';
                        localeIndicator.style.color = '#2b6cb0';
                        
                        // Determine locale from URL
                        const locale = item.url.includes('.mx.') || item.url.includes('.mx/') ? 'es-MX' : 'en';
                        localeIndicator.textContent = `Locale detected: ${locale}`;
                        redirectedCell.appendChild(localeIndicator);
                    }
                } else {
                    redirectedCell.textContent = 'N/A';
                }
                row.appendChild(redirectedCell);
                
                // Status Cell
                const statusCell = document.createElement('td');
                
                // Include the HTTP status code if available
                if (item.http_status) {
                    statusCell.textContent = `${item.status} (${item.http_status})`;
                } else {
                    statusCell.textContent = item.status;
                }
                
                statusCell.className = item.status === 'PASS' ? 'pass' : 'fail';
                row.appendChild(statusCell);
                
                // Product Table Detection Cell
                const productTableCell = document.createElement('td');
                if (item.has_product_table !== undefined) {
                    // Create a container for the product table info
                    const container = document.createElement('div');
                    
                    // Show Yes/No with appropriate styling
                    const statusSpan = document.createElement('span');
                    statusSpan.style.fontWeight = 'bold';
                    
                    if (item.has_product_table) {
                        statusSpan.textContent = 'Yes';
                        statusSpan.style.color = '#38a169'; // Green
                        row.style.backgroundColor = '#f0fff4'; // Light green background for rows with product tables
                    } else {
                        statusSpan.textContent = 'No';
                        statusSpan.style.color = '#4a5568'; // Gray
                    }
                    container.appendChild(statusSpan);
                    
                    // Show the class name if a product table was found 
                    // Log the class name for debugging
                    if (item.has_product_table) {
                        console.log("Product table found for URL: " + item.url);
                        console.log("  Class: " + (item.product_table_class || "None"));
                        
                        // Add more detailed debugging of the response
                        console.log("  Raw item.product_table_class value:", JSON.stringify(item.product_table_class));
                        console.log("  Type of item.product_table_class:", typeof item.product_table_class);
                        if (item.product_table_class) {
                            console.log("  Length of class name:", item.product_table_class.length);
                            console.log("  Character codes:", 
                                Array.from(item.product_table_class).map(c => c.charCodeAt(0)));
                        }
                    }
                    
                    // We no longer display the specific class name in the UI
                    // Just log it to the console for debugging purposes
                    if (item.has_product_table && item.product_table_class) {
                        console.log(`Found product table with class: ${item.product_table_class}`);
                    }
                    
                    // Show any errors that occurred during product table detection
                    if (item.product_table_error) {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.fontSize = '12px';
                        errorDiv.style.marginTop = '4px';
                        errorDiv.style.color = '#e53e3e'; // Red
                        errorDiv.textContent = `Error: ${item.product_table_error}`;
                        container.appendChild(errorDiv);
                    }
                    
                    productTableCell.appendChild(container);
                } else {
                    productTableCell.textContent = 'Not checked';
                    productTableCell.style.color = '#718096'; // Gray
                }
                row.appendChild(productTableCell);
                
                // Issues Cell
                const issuesCell = document.createElement('td');
                if (item.utm_issues && item.utm_issues.length > 0) {
                    const issuesList = document.createElement('ul');
                    issuesList.style.paddingLeft = '20px';
                    
                    item.utm_issues.forEach(issue => {
                        const issueItem = document.createElement('li');
                        
                        // Note that empty webtrends is OK
                        if (issue.includes('webtrends') && issue.includes('missing')) {
                            issueItem.textContent = issue + ' (This is acceptable)';
                            issueItem.style.color = '#718096'; // Gray color to indicate it's not a critical issue
                        } else {
                            issueItem.textContent = issue;
                        }
                        
                        issuesList.appendChild(issueItem);
                    });
                    
                    issuesCell.appendChild(issuesList);
                } else {
                    issuesCell.textContent = 'None';
                }
                row.appendChild(issuesCell);
                
                linksResults.appendChild(row);
            });
            
            // Show results
            showElement(resultsContainer);
        }
    </script>
</body>
</html>
