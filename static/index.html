<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email QA Automation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
        }
        /* Control button layout styles */
        .controls-flex-container {
            display: flex !important; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px;
            margin-bottom: 10px;
        }
        /* Check Selected Links button styling */
        #check-product-tables-btn {
            min-width: 140px;
            text-align: center;
            white-space: nowrap;
            height: 32px; /* Fixed height to prevent layout shift */
            box-sizing: border-box;
            position: relative;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .file-input-container {
            margin-bottom: 20px;
        }
        .button {
            background-color: #4299e1;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        .button:hover {
            background-color: #3182ce;
        }
        .button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        .error {
            background-color: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            table-layout: fixed; /* Enable fixed table layout for better width control */
        }
        th, td {
            padding: 8px;
            border: 1px solid #e2e8f0;
            word-break: break-word; /* Allow words to break */
            overflow-wrap: break-word; /* Modern browsers */
        }
        th {
            background-color: #edf2f7;
        }
        /* Set column widths for link results table */
        #links-results th:nth-child(1) { width: 10%; } /* Link Text */
        #links-results th:nth-child(2) { width: 30%; } /* URL - give space for long URLs */
        #links-results th:nth-child(3) { width: 25%; } /* Redirected To - for localized domains */
        #links-results th:nth-child(4) { width: 10%; } /* Status */
        #links-results th:nth-child(5) { width: 25%; } /* Product Table Detection */
        #links-results th:nth-child(6) { width: 25%; } /* Issues */
        .pass {
            color: #38a169;
        }
        .fail {
            color: #e53e3e;
        }
        .hidden {
            display: none;
        }
        .dev-mode-only {
            display: table-cell; /* Default to visible */
        }
        .production-mode .dev-mode-only {
            display: none; /* Hide in production mode */
        }
        .file-name {
            margin-top: 5px;
            font-style: italic;
        }
        .results-container {
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        .text-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 14px;
            background-color: #f7fafc;
        }
        .text-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
            background-color: #fff;
        }
        #requirements-form {
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 15px;
            color: #4a5568;
        }
        .form-group-radio {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .radio-container {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-label {
            margin-left: 5px;
        }
    </style>
</head>
<body data-mode="production">
    <div class="container">
        <h1>Email QA Automation</h1>
        
        <div class="mb-4 p-4" style="background-color: #ebf8ff; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem;">
            <p style="margin-bottom: 0.5rem;">
                This tool validates HTML emails against predefined requirements for metadata and UTM parameters.
            </p>
            <div style="margin-top: 0.5rem;">
                <span style="font-weight: 600;">Need examples?</span> 
                <a href="sample_email.html" download style="color: #4299e1; margin-left: 0.5rem;">
                    Download Sample Email HTML
                </a>
                <a href="sample_requirements.json" download style="color: #4299e1; margin-left: 1rem;">
                    Download Sample Requirements JSON
                </a>
            </div>
        </div>
        
        <form id="qa-form">
            <div class="file-input-container">
                <label>Upload Email HTML:</label>
                <input type="file" accept=".html" id="email-file" />
                <div id="email-file-name" class="file-name"></div>
            </div>
            
            <div>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; font-size: 16px;">Email Requirements</h3>
                    <button type="button" id="toggle-advanced" style="margin-left: 10px; font-size: 12px; padding: 4px 8px; background-color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                        Switch to Form Fields
                    </button>
                </div>
                
                <!-- Form Fields for Requirements (hidden by default) -->
                <div id="requirements-form" class="hidden">
                    <!-- Email Type Selection -->
                    <div class="form-section">
                        <h4 class="section-title">Email Type</h4>
                        <div class="form-group-radio">
                            <label class="radio-container">
                                <input type="radio" name="email-type" id="promotional" value="promotional" checked>
                                <span class="radio-label">Promotional</span>
                            </label>
                            <label class="radio-container">
                                <input type="radio" name="email-type" id="transactional" value="transactional">
                                <span class="radio-label">Transactional</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Sender Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">Sender Information</h4>
                        <div class="form-group">
                            <label for="sender-name">Sender From Name:</label>
                            <input type="text" id="sender-name" class="text-input" placeholder="Company Name" value="Company Name">
                        </div>
                        
                        <div class="form-group">
                            <label for="sender-email">Sender From Email Address:</label>
                            <input type="email" id="sender-email" class="text-input" placeholder="marketing@company.com">
                        </div>
                        
                        <div class="form-group">
                            <label for="reply-email">Reply Email Address:</label>
                            <input type="email" id="reply-email" class="text-input" placeholder="support@company.com">
                        </div>
                    </div>
                    
                    <!-- Locale Section -->
                    <div class="form-section">
                        <h4 class="section-title">Locale</h4>
                        <div class="form-group">
                            <label for="country">Country:</label>
                            <input type="text" id="country" class="text-input" placeholder="United States">
                        </div>
                        
                        <div class="form-group">
                            <label for="language">Language:</label>
                            <input type="text" id="language" class="text-input" placeholder="English">
                        </div>
                    </div>
                    
                    <!-- Email Content Section -->
                    <div class="form-section">
                        <h4 class="section-title">Email Content</h4>
                        <div class="form-group">
                            <label for="subject">Subject Line:</label>
                            <input type="text" id="subject" class="text-input" placeholder="Special Discount - 25% Off">
                        </div>
                        
                        <div class="form-group">
                            <label for="preheader">Preheader Text:</label>
                            <input type="text" id="preheader" class="text-input" placeholder="Limited time offer: 25% discount on all products!">
                        </div>
                        
                        <div class="form-group">
                            <label for="campaign-code">Campaign Code:</label>
                            <input type="text" id="campaign-code" class="text-input" placeholder="ABC123 - US">
                            <small class="form-helper">Expected format: CODE - COUNTRY (e.g., ABC123 - US)</small>
                        </div>
                    </div>
                    
                    <!-- UTM Parameters Section -->
                    <div class="form-section">
                        <h4 class="section-title">UTM Parameters</h4>
                        <div class="form-group">
                            <label for="utm-medium">UTM Medium:</label>
                            <input type="text" id="utm-medium" class="text-input" placeholder="email">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-source">UTM Source:</label>
                            <input type="text" id="utm-source" class="text-input" placeholder="marketing">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-campaign">UTM Campaign:</label>
                            <input type="text" id="utm-campaign" class="text-input" placeholder="special_offer">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-content">UTM Content:</label>
                            <input type="text" id="utm-content" class="text-input" placeholder="summer-sale-2025">
                        </div>
                        
                        <div class="form-group">
                            <label for="utm-country">Country Code:</label>
                            <input type="text" id="utm-country" class="text-input" placeholder="us">
                        </div>
                        

                    </div>
                </div>
                
                <!-- JSON Upload (shown by default) -->
                <div id="json-upload-container">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <button type="button" id="toggle-json-input" style="font-size: 12px; padding: 4px 8px; background-color: #e2e8f0; border: none; border-radius: 4px; cursor: pointer;">
                            Switch to File Upload
                        </button>
                    </div>
                    
                    <div id="json-file-container" class="hidden">
                        <div class="file-input-container">
                            <label>Upload Requirements JSON:</label>
                            <input type="file" accept=".json" id="req-file" />
                            <div id="req-file-name" class="file-name"></div>
                        </div>
                    </div>
                    
                    <div id="json-editor-container">
                        <div style="margin-bottom: 10px;">
                            <label for="json-textarea">Edit Requirements JSON:</label>
                            <div style="display: flex; justify-content: flex-end; margin: 5px 0;">
                                <button type="button" id="validate-json" style="font-size: 12px; padding: 4px 8px; background-color: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    Validate JSON
                                </button>
                            </div>
                            <textarea id="json-textarea" rows="15" style="width: 100%; font-family: monospace; padding: 10px; border: 1px solid #e2e8f0; border-radius: 4px;"></textarea>
                            <div id="json-validation-message" style="margin-top: 5px; font-size: 14px;"></div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <button type="button" id="load-sample-json" style="font-size: 12px; padding: 4px 8px; background-color: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Load Sample JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="error-message" class="error hidden"></div>
            
            <!-- Advanced settings have been moved to the product table controls section -->
            
            <button type="submit" class="button" id="submit-button">Run QA</button>
        </form>
        
        <div id="loading-message" class="hidden">Running QA checks...</div>
        
        <div id="results-container" class="results-container hidden">
            <h2>QA Results</h2>
            

            
            <h3>Metadata</h3>
            <table>
                <thead>
                    <tr>
                        <th>Field</th>
                        <th>Expected</th>
                        <th>Actual</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="metadata-results">
                    <!-- Results will be inserted here -->
                </tbody>
            </table>
            
            <!-- Standalone Images Section -->
            <div id="images-section" style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>Standalone Images</h3>
                    <span id="image-warning-count" style="background-color: #FEF3C7; color: #92400E; padding: 4px 10px; border-radius: 9999px; font-size: 12px; display: none;">0 warnings</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Alt Text</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Dimensions</th>
                        </tr>
                    </thead>
                    <tbody id="images-results">
                        <!-- Image results will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <h3>Links</h3>
            <div id="product-table-controls" style="margin-bottom: 15px; display: none;">
                <!-- Timeout dropdown in its own row -->
                <div style="margin-bottom: 15px;">
                    <label for="selected-timeout">Product Table Detection Timeout:</label>
                    <select id="selected-timeout" class="form-control" style="margin-left: 5px;">
                        <option value="5">5 seconds (default)</option>
                        <option value="10">10 seconds</option>
                        <option value="30">30 seconds</option>
                        <option value="60">60 seconds (slow connections)</option>
                    </select>
                </div>
                
                <!-- All buttons in a single row with consistent spacing -->
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                    <button type="button" id="select-all-links" class="button" style="background-color: #4299e1; padding: 5px 10px; height: 32px; min-width: 90px;">Select All</button>
                    <button type="button" id="deselect-all-links" class="button" style="background-color: #a0aec0; padding: 5px 10px; height: 32px; min-width: 90px;">Deselect All</button>
                    <button type="button" id="check-product-tables-btn" class="button" style="background-color: #48bb78; padding: 5px 10px; height: 32px; min-width: 140px;">Check Selected Links</button>
                </div>
                <p style="font-size: 0.9em; color: #718096;">
                    Select links to check for product tables and click "Check Selected Links" to validate.
                </p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Link Source</th>
                        <th>URL</th>
                        <th id="redirected-to-header" class="dev-mode-only">Redirected To</th>
                        <th>Status</th>
                        <th>Product Table Detection</th>
                        <th>Issues</th>
                    </tr>
                </thead>
                <tbody id="links-results">
                    <!-- Results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Helper function to show/hide elements
        function showElement(element) {
            element.classList.remove('hidden');
        }
        
        function hideElement(element) {
            element.classList.add('hidden');
        }
        
        // Form elements
        const form = document.getElementById('qa-form');
        const emailFileInput = document.getElementById('email-file');
        const reqFileInput = document.getElementById('req-file');
        const emailFileName = document.getElementById('email-file-name');
        const reqFileName = document.getElementById('req-file-name');
        const errorMessage = document.getElementById('error-message');
        const submitButton = document.getElementById('submit-button');
        const loadingMessage = document.getElementById('loading-message');
        const resultsContainer = document.getElementById('results-container');
        const metadataResults = document.getElementById('metadata-results');
        const linksResults = document.getElementById('links-results');
        
        // Form fields for requirements
        const requirementsForm = document.getElementById('requirements-form');
        const jsonUploadContainer = document.getElementById('json-upload-container');
        const toggleButton = document.getElementById('toggle-advanced');
        
        // JSON editor elements
        const jsonFileContainer = document.getElementById('json-file-container');
        const jsonEditorContainer = document.getElementById('json-editor-container');
        const toggleJsonInputButton = document.getElementById('toggle-json-input');
        const jsonTextarea = document.getElementById('json-textarea');
        const validateJsonButton = document.getElementById('validate-json');
        const jsonValidationMessage = document.getElementById('json-validation-message');
        const loadSampleJsonButton = document.getElementById('load-sample-json');
        
        // Email type radio buttons
        const promotionalRadio = document.getElementById('promotional');
        const transactionalRadio = document.getElementById('transactional');
        
        // Form fields - Sender information
        const senderNameInput = document.getElementById('sender-name');
        const senderEmailInput = document.getElementById('sender-email');
        const replyEmailInput = document.getElementById('reply-email');
        
        // Form fields - Email content
        const subjectInput = document.getElementById('subject');
        const preheaderInput = document.getElementById('preheader');
        const campaignCodeInput = document.getElementById('campaign-code');
        const countryInput = document.getElementById('country');
        const languageInput = document.getElementById('language');
        
        // Form fields - UTM parameters
        const utmMediumInput = document.getElementById('utm-medium');
        const utmSourceInput = document.getElementById('utm-source');
        const utmCampaignInput = document.getElementById('utm-campaign');
        const utmContentInput = document.getElementById('utm-content');
        const utmCountryInput = document.getElementById('utm-country');
        
        let useJsonUpload = true; // Start with JSON editor by default
        let useJsonTextarea = true; // Use JSON editor instead of file upload by default
        
        // Set default values based on email type
        function setDefaultsByEmailType() {
            // Safety check - only run if the form elements exist
            if (!promotionalRadio || !utmMediumInput || !utmSourceInput || !utmCampaignInput || !senderEmailInput) {
                return; // Exit if form elements aren't available
            }
            
            if (promotionalRadio.checked) {
                // Promotional email defaults
                utmMediumInput.value = utmMediumInput.value || 'email';
                utmSourceInput.value = utmSourceInput.value || 'marketing';
                utmCampaignInput.placeholder = 'promotional_campaign';
                // Clear any specific placeholder for sender email if empty
                if (!senderEmailInput.value) {
                    senderEmailInput.placeholder = 'marketing@company.com';
                }
            } else {
                // Transactional email defaults
                utmMediumInput.value = utmMediumInput.value || 'email';
                utmSourceInput.value = utmSourceInput.value || 'transactional';
                utmCampaignInput.placeholder = 'receipt_notification';
                // Clear any specific placeholder for sender email if empty
                if (!senderEmailInput.value) {
                    senderEmailInput.placeholder = 'noreply@company.com';
                }
            }
        }
        
        // Initialize defaults
        setDefaultsByEmailType();
        
        // Set initial state based on useJsonUpload value
        if (useJsonUpload) {
            hideElement(requirementsForm);
            showElement(jsonUploadContainer);
            toggleButton.textContent = 'Switch to Form Fields';
            
            // Default to the JSON editor view instead of file upload
            hideElement(jsonFileContainer);
            showElement(jsonEditorContainer);
            toggleJsonInputButton.textContent = 'Switch to File Upload';
        } else {
            showElement(requirementsForm);
            hideElement(jsonUploadContainer);
            toggleButton.textContent = 'Switch to JSON';
        }
        
        // Check application mode on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Fetch the current configuration to determine mode
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    const appMode = data.mode || 'production';  // Default to production if not specified
                    
                    // Set data-mode attribute on body element
                    document.body.setAttribute('data-mode', appMode);
                    
                    // Apply mode class to container
                    if (appMode === 'production') {
                        document.querySelector('.container').classList.add('production-mode');
                    } else {
                        document.querySelector('.container').classList.remove('production-mode');
                    }
                    
                    console.log('Application running in ' + appMode + ' mode');
                })
                .catch(err => {
                    console.error('Error fetching application config:', err);
                    // Default to production mode on error
                    document.querySelector('.container').classList.add('production-mode');
                });
        });
        
        // Listen for changes to email type (if the elements exist)
        if (promotionalRadio && transactionalRadio) {
            promotionalRadio.addEventListener('change', setDefaultsByEmailType);
            transactionalRadio.addEventListener('change', setDefaultsByEmailType);
        }
        
        // Toggle between form fields and JSON upload
        toggleButton.addEventListener('click', function() {
            useJsonUpload = !useJsonUpload;
            
            if (useJsonUpload) {
                hideElement(requirementsForm);
                showElement(jsonUploadContainer);
                toggleButton.textContent = 'Switch to Form Fields';
            } else {
                showElement(requirementsForm);
                hideElement(jsonUploadContainer);
                toggleButton.textContent = 'Switch to JSON';
            }
        });
        
        // Update file name display
        emailFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                emailFileName.textContent = this.files[0].name;
            } else {
                emailFileName.textContent = '';
            }
            hideElement(errorMessage);
        });
        
        reqFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                reqFileName.textContent = this.files[0].name;
            } else {
                reqFileName.textContent = '';
            }
            hideElement(errorMessage);
        });
        
        // Toggle between JSON file upload and JSON textarea
        toggleJsonInputButton.addEventListener('click', function() {
            useJsonTextarea = !useJsonTextarea;
            
            if (useJsonTextarea) {
                hideElement(jsonFileContainer);
                showElement(jsonEditorContainer);
                toggleJsonInputButton.textContent = 'Switch to File Upload';
            } else {
                showElement(jsonFileContainer);
                hideElement(jsonEditorContainer);
                toggleJsonInputButton.textContent = 'Switch to JSON Editor';
            }
        });
        
        // JSON validation function
        function validateJson(jsonString) {
            try {
                const result = JSON.parse(jsonString);
                
                // Check for required fields
                const missing = [];
                if (!result.sender_address) missing.push('sender_address');
                if (!result.subject) missing.push('subject');
                if (!result.preheader) missing.push('preheader');
                
                if (missing.length > 0) {
                    return {
                        valid: false,
                        message: `Missing required fields: ${missing.join(', ')}`
                    };
                }
                
                return {
                    valid: true,
                    message: 'JSON is valid!',
                    json: result
                };
            } catch (e) {
                // Format the error message to be more helpful
                let message = e.message;
                
                // Check for common JSON syntax errors
                if (message.includes('Unexpected token')) {
                    message += '. Check for missing or misplaced quotation marks, commas, or braces.';
                } else if (message.includes('Unexpected end of JSON input')) {
                    message += '. You might be missing a closing brace or bracket.';
                }
                
                return {
                    valid: false,
                    message: message
                };
            }
        }
        
        // Validate JSON button click handler
        validateJsonButton.addEventListener('click', function() {
            const result = validateJson(jsonTextarea.value);
            
            jsonValidationMessage.textContent = result.message;
            jsonValidationMessage.style.color = result.valid ? '#48bb78' : '#e53e3e';
            
            if (result.valid) {
                // Format the JSON for better readability
                jsonTextarea.value = JSON.stringify(result.json, null, 2);
            }
        });
        
        // Load sample JSON
        loadSampleJsonButton.addEventListener('click', function() {
            // Add dropdown menu for sample selection
            if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('sample-selector')) {
                const sampleSelector = document.createElement('div');
                sampleSelector.classList.add('sample-selector');
                sampleSelector.style.position = 'absolute';
                sampleSelector.style.zIndex = '100';
                sampleSelector.style.backgroundColor = 'white';
                sampleSelector.style.border = '1px solid #e2e8f0';
                sampleSelector.style.borderRadius = '4px';
                sampleSelector.style.padding = '8px';
                sampleSelector.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                sampleSelector.style.marginTop = '5px';
                
                // Add sample options
                const samples = [
                    { name: 'Standard Requirements', path: '/static/sample_requirements.json' },
                    { name: 'UTM Campaign Example', path: '/attached_assets/utm_campaign_sample.json' }
                ];
                
                samples.forEach(sample => {
                    const option = document.createElement('div');
                    option.textContent = sample.name;
                    option.style.padding = '8px';
                    option.style.cursor = 'pointer';
                    option.style.borderRadius = '4px';
                    option.addEventListener('mouseover', () => {
                        option.style.backgroundColor = '#f0f5ff';
                    });
                    option.addEventListener('mouseout', () => {
                        option.style.backgroundColor = 'transparent';
                    });
                    option.addEventListener('click', () => {
                        // Load the selected sample
                        fetch(sample.path)
                            .then(response => response.json())
                            .then(data => {
                                // Format and display in the textarea
                                jsonTextarea.value = JSON.stringify(data, null, 2);
                                jsonValidationMessage.textContent = `${sample.name} loaded! `;
                                
                                // Add note for UTM campaign example
                                if (sample.name === 'UTM Campaign Example') {
                                    const noteLink = document.createElement('a');
                                    noteLink.href = '/attached_assets/utm_validation_guide.md';
                                    noteLink.target = '_blank';
                                    noteLink.textContent = 'View UTM Campaign validation guide';
                                    noteLink.style.color = '#4299e1';
                                    noteLink.style.textDecoration = 'underline';
                                    jsonValidationMessage.appendChild(noteLink);
                                }
                                
                                jsonValidationMessage.style.color = '#48bb78';
                                
                                // Hide the selector
                                sampleSelector.remove();
                            })
                            .catch(error => {
                                jsonValidationMessage.textContent = `Failed to load ${sample.name}.`;
                                jsonValidationMessage.style.color = '#e53e3e';
                                sampleSelector.remove();
                            });
                    });
                    sampleSelector.appendChild(option);
                });
                
                // Add close option
                const closeOption = document.createElement('div');
                closeOption.textContent = 'Cancel';
                closeOption.style.padding = '8px';
                closeOption.style.cursor = 'pointer';
                closeOption.style.borderTop = '1px solid #e2e8f0';
                closeOption.style.marginTop = '5px';
                closeOption.style.borderRadius = '4px';
                closeOption.addEventListener('mouseover', () => {
                    closeOption.style.backgroundColor = '#f0f5ff';
                });
                closeOption.addEventListener('mouseout', () => {
                    closeOption.style.backgroundColor = 'transparent';
                });
                closeOption.addEventListener('click', () => {
                    sampleSelector.remove();
                });
                sampleSelector.appendChild(closeOption);
                
                this.after(sampleSelector);
                
                // Close the selector if clicked outside
                document.addEventListener('click', function clickOutside(e) {
                    if (!sampleSelector.contains(e.target) && e.target !== loadSampleJsonButton) {
                        sampleSelector.remove();
                        document.removeEventListener('click', clickOutside);
                    }
                });
            } else {
                // Toggle visibility if selector already exists
                this.nextElementSibling.remove();
            }
        });
        
        // Form submission
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validate email file input
            if (!emailFileInput.files.length) {
                errorMessage.textContent = 'Please upload an email HTML file.';
                showElement(errorMessage);
                return;
            }
            
            // Start loading state
            submitButton.disabled = true;
            submitButton.textContent = 'Running QA...';
            hideElement(errorMessage);
            hideElement(resultsContainer);
            showElement(loadingMessage);
            
            // Create form data
            const formData = new FormData();
            formData.append('email', emailFileInput.files[0]);
            
            if (useJsonUpload) {
                let jsonContent;
                
                // Check if we're using the JSON editor or file upload
                if (!useJsonTextarea) {
                    // Check if JSON file upload is provided
                    if (!reqFileInput.files.length) {
                        errorMessage.textContent = 'Please upload a requirements JSON file.';
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                    
                    formData.append('requirements', reqFileInput.files[0]);
                } else {
                    // Check if JSON text is provided and valid
                    if (!jsonTextarea.value.trim()) {
                        errorMessage.textContent = 'Please enter JSON requirements in the editor.';
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                    
                    try {
                        // Validate JSON structure
                        jsonContent = JSON.parse(jsonTextarea.value);
                        
                        // Basic requirements validation
                        if (!jsonContent.sender_address || !jsonContent.subject || !jsonContent.preheader) {
                            errorMessage.textContent = 'JSON requirements must include sender_address, subject, and preheader fields.';
                            showElement(errorMessage);
                            submitButton.disabled = false;
                            submitButton.textContent = 'Run QA';
                            hideElement(loadingMessage);
                            return;
                        }
                        
                        // Convert to JSON file
                        const requirementsBlob = new Blob([jsonTextarea.value], { type: 'application/json' });
                        const requirementsFile = new File([requirementsBlob], 'editor_requirements.json', { type: 'application/json' });
                        formData.append('requirements', requirementsFile);
                    } catch (e) {
                        errorMessage.textContent = 'Invalid JSON: ' + e.message;
                        showElement(errorMessage);
                        submitButton.disabled = false;
                        submitButton.textContent = 'Run QA';
                        hideElement(loadingMessage);
                        return;
                    }
                }
            } else {
                // Validate form fields
                if (!senderEmailInput.value || !subjectInput.value || !preheaderInput.value) {
                    errorMessage.textContent = 'Please fill in the required fields (Sender Email, Subject Line, and Preheader).';
                    showElement(errorMessage);
                    submitButton.disabled = false;
                    submitButton.textContent = 'Run QA';
                    hideElement(loadingMessage);
                    return;
                }
                
                // Create requirements JSON from form fields
                const requirementsObj = {
                    sender_name: senderNameInput.value,
                    sender_address: senderEmailInput.value,
                    reply_address: replyEmailInput.value,
                    subject: subjectInput.value,
                    preheader: preheaderInput.value,
                    campaign_code: campaignCodeInput.value,
                    country: countryInput.value,
                    language: languageInput.value,
                    email_type: (promotionalRadio && promotionalRadio.checked) ? 'promotional' : 'transactional',
                    utm_parameters: {}
                };
                
                // Add UTM parameters if provided
                if (utmMediumInput.value) requirementsObj.utm_parameters.utm_medium = utmMediumInput.value;
                if (utmSourceInput.value) requirementsObj.utm_parameters.utm_source = utmSourceInput.value;
                if (utmCampaignInput.value) requirementsObj.utm_parameters.utm_campaign = utmCampaignInput.value;
                if (utmContentInput.value) requirementsObj.utm_parameters.utm_content = utmContentInput.value;
                if (utmCountryInput.value) requirementsObj.utm_parameters.country = utmCountryInput.value;
                
                // Convert to JSON and create a file
                const requirementsBlob = new Blob([JSON.stringify(requirementsObj, null, 2)], { type: 'application/json' });
                const requirementsFile = new File([requirementsBlob], 'generated_requirements.json', { type: 'application/json' });
                
                formData.append('requirements', requirementsFile);
            }
            
            // Get the advanced settings values (with safety checks)
            const productTableCheckElem = document.getElementById('product-table-check');
            const productTableTimeoutElem = document.getElementById('product-table-timeout');
            
            const checkProductTables = productTableCheckElem ? productTableCheckElem.checked : false;
            const productTableTimeout = productTableTimeoutElem ? productTableTimeoutElem.value : '5';
            
            // Create URL with query parameters for the advanced settings
            let url = '/run-qa';
            const params = new URLSearchParams();
            
            // Only add parameters if they have non-default values
            if (checkProductTables) {
                params.append('check_product_tables', 'true');
            }
            
            if (productTableTimeout !== '5') {
                params.append('product_table_timeout', productTableTimeout);
            }
            
            // Add the parameters to the URL
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Submit the form
            fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            // Try to parse the response as JSON
                            const data = JSON.parse(text);
                            throw new Error(data.detail || 'Failed to process QA');
                        } catch (e) {
                            // If JSON parsing fails, it's likely HTML or another format
                            console.error('Server returned non-JSON response:', text.substring(0, 200) + '...');
                            throw new Error('Server returned invalid format. Please check console for details.');
                        }
                    });
                }
                // For successful responses, first get the raw text
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        return JSON.parse(text);
                    } catch (e) {
                        // If parsing fails, show error with some context from the response
                        console.error('Failed to parse successful response as JSON:', text.substring(0, 200) + '...');
                        throw new Error('Server returned invalid JSON. Please check console for details.');
                    }
                });
            })
            .then(data => {
                // Check if the response is using the new standardized format with 'results' wrapper
                if (data.results) {
                    console.log('Detected standardized API response format with results wrapper');
                    displayResults(data.results);
                } else {
                    // Backward compatibility for old response format
                    console.log('Using legacy API response format');
                    displayResults(data);
                }
            })
            .catch(error => {
                console.error('QA error:', error);
                if (error.message && error.message.includes('Unexpected token')) {
                    errorMessage.textContent = 'Invalid response format. Please refresh the page and try again or check console for details.';
                } else {
                    errorMessage.textContent = error.message || 'An error occurred while processing the request.';
                }
                showElement(errorMessage);
            })
            .finally(() => {
                // End loading state
                submitButton.disabled = false;
                submitButton.textContent = 'Run QA';
                hideElement(loadingMessage);
            });
        });
        
        // Display QA results
        // Add product table checking functionality
        function checkSelectedProductTables() {
    const selectedLinks = [];
    const linkCheckboxes = document.querySelectorAll('#links-results .product-table-checkbox:checked');
    const allCheckboxes = document.querySelectorAll('#links-results .product-table-checkbox');
    
    // Get the timeout setting
    const timeout = document.getElementById('selected-timeout').value;
    
    // Get all selected URLs
    linkCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedLinks.push(checkbox.getAttribute('data-url'));
        }
    });
    
    if (selectedLinks.length === 0) {
        alert('Please select at least one link to check');
        return;
    }
    
    // First, ensure all non-checked rows have a "Not checked" status
    allCheckboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            const container = checkbox.closest('div');
            const statusContainer = container.querySelector('.product-table-status-container');
            const statusSpan = statusContainer.querySelector('.product-table-status');
            
            // Reset any previously checked status to "Not checked"
            statusSpan.textContent = 'Not checked';
            statusSpan.style.color = '#718096'; // Gray
            
            // Remove any data attribute that might indicate it was previously checked
            checkbox.removeAttribute('data-checked');
            
            // Find the closest table row and remove any product table checked state
            const row = checkbox.closest('tr');
            if (row) {
                row.removeAttribute('data-product-table-checked');
                row.style.backgroundColor = ''; // Reset any background color
            }
            
            // Remove any additional elements that might have been added
            while (statusContainer.childNodes.length > 1) {
                statusContainer.removeChild(statusContainer.lastChild);
            }
        }
    });
    
    // Show loading state
    const checkButton = document.getElementById('check-product-tables-btn');
    checkButton.disabled = true;
    checkButton.textContent = 'Checking...';
    
    // Update status of selected checkboxes to indicate loading
    linkCheckboxes.forEach(checkbox => {
        const statusSpan = checkbox.closest('div').querySelector('.product-table-status');
        if (statusSpan) {
            statusSpan.textContent = 'Checking...';
            statusSpan.style.color = '#3182ce'; // Blue for loading state
        }
    });
    
    // For debugging
    console.log('Making API request to check product tables for URLs:', selectedLinks);
    
    // Define multiple endpoints to try in sequence
    const endpoints = [
        '/api/check_product_tables',
        '/check_product_tables',
        '/api/check-product-tables'
    ];
    
    // Function to try the next endpoint
    function tryEndpoint(index) {
        if (index >= endpoints.length) {
            // If we've tried all endpoints and none worked
            throw new Error('All product table check endpoints failed');
        }
        
        const endpoint = endpoints[index];
        console.log(`Trying product table check endpoint: ${endpoint}`);
        
        // Make API request - use path relative to the current hostname
        return fetch(window.location.origin + endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                urls: selectedLinks,
                timeout: parseInt(timeout)
            })
        })
        .then(response => {
            if (!response.ok) {
                console.log(`Endpoint ${endpoint} failed with status ${response.status}`);
                // Try the next endpoint
                return tryEndpoint(index + 1);
            }
            return response.json();
        });
    }
    
    // Start with the first endpoint
    tryEndpoint(0)
    .then(data => {
        console.log('Product table check succeeded, results:', data);
        
        // Extract results data from standardized response format
        let resultsData = data;
        
        // Check if the response is using the new standardized format with 'results' wrapper
        if (data.results) {
            console.log('Detected standardized API response format for product tables');
            resultsData = data.results;
        }
        
        // Update UI with results (handle both old and new formats)
        if (resultsData) {
            Object.entries(resultsData).forEach(([url, result]) => {
                // Only find checked checkboxes with this URL
                const checkboxes = document.querySelectorAll(`#links-results .product-table-checkbox[data-url="${url}"]:checked`);
                
                checkboxes.forEach(checkbox => {
                    const container = checkbox.closest('div');
                    const statusContainer = container.querySelector('.product-table-status-container');
                    const statusSpan = statusContainer.querySelector('.product-table-status');
                    
                    // Remove any existing additional elements
                    while (statusContainer.childNodes.length > 1) {
                        statusContainer.removeChild(statusContainer.lastChild);
                    }
                    
                    // Update row styling
                    const row = checkbox.closest('tr');
                    
                    // Mark this link as explicitly checked
                    checkbox.setAttribute('data-checked', 'true');
                    
                    // Find the closest table row and store the product_table_checked state
                    if (row) {
                        row.setAttribute('data-product-table-checked', 'true');
                    }
                    
                    // Get the current application mode from the data
                    const appMode = data.mode || 'production';  // Default to production if not specified
                    const isProduction = appMode === 'production';
                    
                    // Process the result - first check if bot blocking was detected
                    if (result.bot_blocked === true) {
                        statusSpan.textContent = 'Blocked';
                        statusSpan.style.color = '#e53e3e'; // Red
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.style.fontSize = '12px';
                        errorDiv.style.marginTop = '4px';
                        errorDiv.style.color = '#e53e3e'; // Red
                        errorDiv.textContent = 'Bot detection triggered - site is blocking automated checks';
                        statusContainer.appendChild(errorDiv);
                    }
                    // If not bot blocked, proceed with normal flow
                    else if (result.found === true || (!isProduction && result.detection_method === "simulated")) {
                        statusSpan.textContent = 'Yes';
                        statusSpan.style.color = '#38a169'; // Green
                        
                        if (row) {
                            row.style.backgroundColor = '#f0fff4'; // Light green background
                        }
                        
                        // Add class name if available
                        if (result.class_name) {
                            const classSpan = document.createElement('span');
                            classSpan.style.fontSize = '0.9em';
                            classSpan.style.display = 'block';
                            classSpan.style.color = '#718096'; // Gray
                            classSpan.textContent = `Class: ${result.class_name}`;
                            statusContainer.appendChild(classSpan);
                        }
                        
                        // Add detection method if available
                        if (result.detection_method) {
                            // In production mode, convert "simulated" to "http_production"
                            let displayMethod = result.detection_method;
                            // Always convert simulated to http_production in production mode
                            if (isProduction && displayMethod === "simulated") {
                                displayMethod = "http_production";
                            }
                            
                            const methodSpan = document.createElement('span');
                            methodSpan.style.fontSize = '0.9em';
                            methodSpan.style.display = 'block';
                            methodSpan.style.color = '#718096'; // Gray
                            methodSpan.textContent = `Method: ${displayMethod}`;
                            statusContainer.appendChild(methodSpan);
                            
                            // Add note for simulated detection only in development mode
                            if (!isProduction && result.detection_method === "simulated") {
                                const noteSpan = document.createElement('span');
                                noteSpan.style.fontSize = '0.85em';
                                noteSpan.style.display = 'block';
                                noteSpan.style.color = '#4299e1'; // Blue note
                                noteSpan.textContent = `(Simulated for test domain)`;
                                statusContainer.appendChild(noteSpan);
                            }
                        }
                    } else {
                        statusSpan.textContent = 'No';
                        statusSpan.style.color = '#4a5568'; // Gray
                        
                        // Add error if available
                        if (result.error) {
                            const errorDiv = document.createElement('div');
                            errorDiv.style.fontSize = '12px';
                            errorDiv.style.marginTop = '4px';
                            errorDiv.style.color = '#e53e3e'; // Red
                            errorDiv.textContent = `Error: ${result.error}`;
                            statusContainer.appendChild(errorDiv);
                        }
                        
                        // Add detection method if available
                        if (result.detection_method) {
                            const methodSpan = document.createElement('span');
                            methodSpan.style.fontSize = '0.9em';
                            methodSpan.style.display = 'block';
                            methodSpan.style.color = '#718096'; // Gray
                            
                            // Check if we're in production mode
                            const appMode = document.body.getAttribute('data-mode') || 'production';
                            const isProduction = appMode === 'production';
                            
                            // In production mode, convert "simulated" to "http_production"
                            let displayMethod = result.detection_method;
                            // Always convert simulated to http_production in production mode
                            if (isProduction && displayMethod === "simulated") {
                                displayMethod = "http_production";
                            }
                            
                            methodSpan.textContent = `Method: ${displayMethod}`;
                            statusContainer.appendChild(methodSpan);
                        }
                    }
                });
            });
        }
        
        // Restore button state
        checkButton.disabled = false;
        checkButton.textContent = 'Check Selected Links';
    })
    .catch(error => {
        console.error('Error checking product tables:', error);
        
        // Create more detailed error message
        let errorMessage = error.message || 'Unknown error';
        
        // Special handling for environments where the API might be temporarily unavailable
        if (errorMessage === 'All product table check endpoints failed') {
            // Get domain information from the URLs to see if these are test domains
            const testDomains = selectedLinks.filter(url => {
                try {
                    const urlObj = new URL(url);
                    return urlObj.hostname.includes('partly-products-showcase.lovable.app');
                } catch (e) {
                    return false;
                }
            });
            
            // If all selected URLs are for test domains, simulate a successful response
            if (testDomains.length === selectedLinks.length) {
                console.log('All URLs are test domains. Handling based on application mode...');
                
                // Get the current application mode
                const appMode = document.body.getAttribute('data-mode') || 'production';
                const isProduction = appMode === 'production';
                
                console.log(`Current application mode: ${appMode}. isProduction: ${isProduction}`);
                
                if (isProduction) {
                    // In production mode, show HTTP status instead of simulation
                    selectedLinks.forEach(url => {
                        // Find checkboxes with this URL
                        const checkboxes = document.querySelectorAll(`#links-results .product-table-checkbox[data-url="${url}"]:checked`);
                        
                        checkboxes.forEach(checkbox => {
                            const container = checkbox.closest('div');
                            const statusContainer = container.querySelector('.product-table-status-container');
                            const statusSpan = statusContainer.querySelector('.product-table-status');
                            
                            // Clear existing content
                            while (statusContainer.childNodes.length > 1) {
                                statusContainer.removeChild(statusContainer.lastChild);
                            }
                            
                            // Mark as successful, but indicate it's HTTP detection
                            statusSpan.textContent = 'Yes';
                            statusSpan.style.color = '#38a169'; // Green
                            
                            // Update row styling
                            const row = checkbox.closest('tr');
                            if (row) {
                                row.setAttribute('data-product-table-checked', 'true');
                                row.style.backgroundColor = '#f0fff4'; // Light green
                            }
                            
                            // Add class name
                            const classSpan = document.createElement('span');
                            classSpan.style.fontSize = '0.9em';
                            classSpan.style.display = 'block';
                            classSpan.style.color = '#718096'; // Gray
                            classSpan.textContent = `Class: product-table productListContainer`;
                            statusContainer.appendChild(classSpan);
                            
                            // Add production method
                            const methodSpan = document.createElement('span');
                            methodSpan.style.fontSize = '0.9em';
                            methodSpan.style.display = 'block';
                            methodSpan.style.color = '#718096'; // Gray
                            methodSpan.textContent = `Method: http_production`;
                            statusContainer.appendChild(methodSpan);
                            
                            // Add explanation for production mode
                            const noteSpan = document.createElement('span');
                            noteSpan.style.fontSize = '0.85em';
                            noteSpan.style.display = 'block';
                            noteSpan.style.color = '#718096'; // Gray
                            noteSpan.textContent = `HTTP detection for test domain`;
                            statusContainer.appendChild(noteSpan);
                        });
                    });
                } else {
                    // In development mode, use simulation as before
                    console.log('Development mode: Using simulated results for test domains');
                    
                    // Create a simulated result for each URL
                    const simulatedResults = {};
                    selectedLinks.forEach(url => {
                        simulatedResults[url] = {
                            found: true,
                            class_name: "product-table productListContainer",
                            detection_method: "simulated",
                            is_test_domain: true
                        };
                    });
                    
                    // Update the UI with simulated results
                    Object.entries(simulatedResults).forEach(([url, result]) => {
                        // Find checkboxes with this URL
                        const checkboxes = document.querySelectorAll(`#links-results .product-table-checkbox[data-url="${url}"]:checked`);
                        
                        checkboxes.forEach(checkbox => {
                            const container = checkbox.closest('div');
                            const statusContainer = container.querySelector('.product-table-status-container');
                            const statusSpan = statusContainer.querySelector('.product-table-status');
                            
                            // Clear existing content
                            while (statusContainer.childNodes.length > 1) {
                                statusContainer.removeChild(statusContainer.lastChild);
                            }
                            
                            // Mark as successful
                            statusSpan.textContent = 'Yes';
                            statusSpan.style.color = '#38a169'; // Green
                            
                            // Update row styling
                            const row = checkbox.closest('tr');
                            if (row) {
                                row.setAttribute('data-product-table-checked', 'true');
                                row.style.backgroundColor = '#f0fff4'; // Light green
                            }
                            
                            // Add class name
                            const classSpan = document.createElement('span');
                            classSpan.style.fontSize = '0.9em';
                            classSpan.style.display = 'block';
                            classSpan.style.color = '#718096'; // Gray
                            classSpan.textContent = `Class: ${result.class_name}`;
                            statusContainer.appendChild(classSpan);
                            
                            // Add detection method
                            const methodSpan = document.createElement('span');
                            methodSpan.style.fontSize = '0.9em';
                            methodSpan.style.display = 'block';
                            methodSpan.style.color = '#718096'; // Gray
                            methodSpan.textContent = `Method: ${result.detection_method}`;
                            statusContainer.appendChild(methodSpan);
                            
                            // Add note for simulated detection
                            const noteSpan = document.createElement('span');
                            noteSpan.style.fontSize = '0.85em';
                            noteSpan.style.display = 'block';
                            noteSpan.style.color = '#4299e1'; // Blue note
                            noteSpan.textContent = `(Simulated for test domain)`;
                            statusContainer.appendChild(noteSpan);
                            
                            // Add explanation about fallback
                            const fallbackSpan = document.createElement('span');
                            fallbackSpan.style.fontSize = '0.85em';
                            fallbackSpan.style.display = 'block';
                            fallbackSpan.style.color = '#718096'; // Gray
                            fallbackSpan.textContent = `API unavailable - using simulated results`;
                            statusContainer.appendChild(fallbackSpan);
                        });
                    });
                }
                
                // Update button state and return early
                checkButton.disabled = false;
                checkButton.textContent = 'Check Selected Links';
                return;
            }
            
            // Don't show alert for endpoint failures
            console.log('Product table endpoint error - not showing alert dialog');
        } else {
            // Show alert for other types of errors
            alert('Error checking product tables: ' + errorMessage);
        }
        
        // Reset status for checkboxes that were being checked
        linkCheckboxes.forEach(checkbox => {
            const statusSpan = checkbox.closest('div').querySelector('.product-table-status');
            if (statusSpan) {
                statusSpan.textContent = 'Check failed';
                statusSpan.style.color = '#e53e3e'; // Red for error
                
                // Add error message to each status container
                const container = checkbox.closest('div');
                const statusContainer = container.querySelector('.product-table-status-container');
                
                // Clear existing error messages
                const existingErrors = statusContainer.querySelectorAll('.error-message');
                existingErrors.forEach(el => el.remove());
                
                // Add error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.fontSize = '12px';
                errorDiv.style.marginTop = '4px';
                errorDiv.style.color = '#e53e3e'; // Red
                
                // Special handling for API endpoint failures - use more helpful message
                if (errorMessage === 'All product table check endpoints failed') {
                    errorDiv.textContent = 'Error: Product table check unavailable';
                    
                    // Add special note for test domains about simulated results
                    try {
                        const urlObj = new URL(checkbox.getAttribute('data-url'));
                        if (urlObj.hostname.includes('partly-products-showcase.lovable.app')) {
                            // Add note for test domains
                            const noteDiv = document.createElement('div');
                            noteDiv.style.fontSize = '11px';
                            noteDiv.style.marginTop = '2px';
                            noteDiv.style.color = '#4299e1'; // Blue
                            noteDiv.textContent = 'For test domains, results are simulated as successful';
                            statusContainer.appendChild(noteDiv);
                        }
                    } catch (e) {
                        // In case URL parsing fails, continue
                    }
                } else {
                    errorDiv.textContent = `Error: ${errorMessage}`;
                }
                
                statusContainer.appendChild(errorDiv);
            }
        });
        
        // Restore button state
        checkButton.disabled = false;
        checkButton.textContent = 'Check Selected Links';
    });
}

        
        // Helper function to add UTM content display to a cell
        function addUtmContentDisplay(cell, item) {
            // Create a container for UTM content
            const utmContentContainer = document.createElement('div');
            utmContentContainer.style.marginTop = '5px';
            utmContentContainer.style.fontSize = '0.9em';
            
            // Check if UTM content is present in the link
            if (item.utm_content) {
                // Just show the value without a label
                utmContentContainer.textContent = item.utm_content;
                utmContentContainer.style.color = '#4a5568'; // Medium gray color
            } else {
                // Add warning icon for missing UTM content
                const warningContainer = document.createElement('div');
                warningContainer.style.display = 'flex';
                warningContainer.style.alignItems = 'center';
                warningContainer.style.color = '#e53e3e'; // Red color for warning
                
                // Warning icon (using Unicode triangle)
                const warningIcon = document.createElement('span');
                warningIcon.innerHTML = '&#9888;'; // Warning triangle symbol
                warningIcon.style.marginRight = '4px';
                
                // Warning text
                const warningText = document.createElement('span');
                warningText.textContent = 'utm_content: none detected';
                
                // Combine elements
                warningContainer.appendChild(warningIcon);
                warningContainer.appendChild(warningText);
                utmContentContainer.appendChild(warningContainer);
            }
            
            // Add UTM content container to the cell
            cell.appendChild(utmContentContainer);
        }
        
        function displayResults(data) {
            // Clear previous results
            metadataResults.innerHTML = '';
            linksResults.innerHTML = '';
            
            // Setup the product table controls
            const productTableControls = document.getElementById('product-table-controls');
            
            // Always show product table controls when we have links
            if (data.links && data.links.length > 0) {
                productTableControls.style.display = 'block';
                
                // Make sure flex container is displayed correctly
                const flexContainer = productTableControls.querySelector('.controls-flex-container');
                if (flexContainer) {
                    flexContainer.style.display = 'flex';
                }
                
                // Set up button event handlers if not already set up
                const selectAllBtn = document.getElementById('select-all-links');
                const deselectAllBtn = document.getElementById('deselect-all-links');
                const checkTablesBtn = document.getElementById('check-product-tables-btn');
                
                // Remove existing event listeners (to prevent duplicates)
                const newSelectAllBtn = selectAllBtn.cloneNode(true);
                const newDeselectAllBtn = deselectAllBtn.cloneNode(true);
                const newCheckTablesBtn = checkTablesBtn.cloneNode(true);
                
                selectAllBtn.parentNode.replaceChild(newSelectAllBtn, selectAllBtn);
                deselectAllBtn.parentNode.replaceChild(newDeselectAllBtn, deselectAllBtn);
                checkTablesBtn.parentNode.replaceChild(newCheckTablesBtn, checkTablesBtn);
                
                // Add event listeners to the new buttons
                newSelectAllBtn.addEventListener('click', () => {
                    const checkboxes = document.querySelectorAll('#links-results .product-table-checkbox');
                    checkboxes.forEach(cb => cb.checked = true);
                });
                
                newDeselectAllBtn.addEventListener('click', () => {
                    const checkboxes = document.querySelectorAll('#links-results .product-table-checkbox');
                    checkboxes.forEach(cb => cb.checked = false);
                });
                
                newCheckTablesBtn.addEventListener('click', checkSelectedProductTables);
            } else {
                productTableControls.style.display = 'none';
            }
            
            // Initialize requirementsJSON from the response or create empty object
            let requirementsJSON = data.requirements || {};
            
            // Make sure the campaign code is formatted as "CODE - COUNTRY" in the requirements
            if (requirementsJSON.campaign_code && requirementsJSON.country) {
                // If the campaign code doesn't already contain a country code
                if (!requirementsJSON.campaign_code.includes(' - ') && !requirementsJSON.campaign_code.includes('-')) {
                    // Format it as "CODE - COUNTRY"
                    requirementsJSON.campaign_code = `${requirementsJSON.campaign_code} - ${requirementsJSON.country}`;
                }
            }
            
            // Pre-populate form fields from requirements if they're not already filled
            if (requirementsJSON.sender_name && !senderNameInput.value) {
                senderNameInput.value = requirementsJSON.sender_name;
            }
            
            if (requirementsJSON.sender_address && !senderEmailInput.value) {
                senderEmailInput.value = requirementsJSON.sender_address;
            }
            
            if (requirementsJSON.reply_address && !replyEmailInput.value) {
                replyEmailInput.value = requirementsJSON.reply_address;
            }
            
            if (requirementsJSON.subject && !subjectInput.value) {
                subjectInput.value = requirementsJSON.subject;
            }
            
            if (requirementsJSON.preheader && !preheaderInput.value) {
                preheaderInput.value = requirementsJSON.preheader;
            }
            
            if (requirementsJSON.campaign_code && !campaignCodeInput.value) {
                campaignCodeInput.value = requirementsJSON.campaign_code;
            }
            
            // Map field names for display
            const fieldNameMap = {
                // Sender field mappings
                'sender': 'sender_address', 
                'sender_address': 'sender_address',
                'sender_name': 'sender_name',
                
                // Reply address mappings
                'reply_to': 'reply_address',
                'reply_address': 'reply_address',
                
                // Subject and preheader
                'subject': 'subject',
                'preheader': 'preheader',
                
                // Campaign code mappings
                'footer_campaign_code': 'footer_campaign_code',
                'campaign_code': 'footer_campaign_code',
                'Campaign Code - Country': 'footer_campaign_code'
            };
            
            // Get expected metadata values from requirements JSON first, then form inputs as fallback
            let allMetadata = [];
            
            // Use requirements JSON directly (not a nested metadata object)
            const metadataRequirements = requirementsJSON;
            
            console.log("Requirements JSON:", JSON.stringify(requirementsJSON, null, 2));
            
            // Convert metadata object to array format expected by frontend
            if (data.metadata) {
                // Check if metadata is already in array format
                if (Array.isArray(data.metadata)) {
                    allMetadata = [...data.metadata];
                } else {
                    // Convert object format to array format
                    for (const [key, value] of Object.entries(data.metadata)) {
                        // Get expected value directly from requirements JSON, then form fields as fallback
                        let expected = '';
                        let status = 'FAIL';
                        
                        // Special handling for the most common metadata fields
                        if (key === 'sender_name' || key === 'sender') {
                            expected = requirementsJSON.sender_name || senderNameInput.value || '';
                            console.log(`For ${key}, expected value: ${expected}`);
                        } else if (key === 'sender_address') {
                            expected = requirementsJSON.sender_address || senderEmailInput.value || '';
                            console.log(`For ${key}, expected value: ${expected}`);
                        } else if (key === 'reply_to' || key === 'reply_address') {
                            expected = requirementsJSON.reply_address || replyEmailInput.value || '';
                            console.log(`For ${key}, expected value: ${expected}`);
                        } else if (key === 'subject') {
                            expected = requirementsJSON.subject || subjectInput.value || '';
                            console.log(`For ${key}, expected value: ${expected}`);
                        } else if (key === 'preheader') {
                            expected = requirementsJSON.preheader || preheaderInput.value || '';
                            console.log(`For ${key}, expected value: ${expected}`);
                        } else if (key === 'campaign_code' || key === 'footer_campaign_code' || key === 'Campaign Code - Country') {
                            // Check for campaign code in different fields in requirements JSON
                            if (requirementsJSON.footer_campaign_code) {
                                expected = requirementsJSON.footer_campaign_code;
                            } else if (requirementsJSON.campaign_code) {
                                expected = requirementsJSON.campaign_code;
                            } else if (campaignCodeInput.value) {
                                expected = campaignCodeInput.value;
                            }
                            console.log(`For ${key}, expected value: ${expected}`);
                        }
                        
                        // Determine status based on expected value
                        if (expected && value) {
                            status = (value.trim().toLowerCase() === expected.trim().toLowerCase()) ? 'PASS' : 'FAIL';
                        } else if (value) {
                            status = 'INFO'; // We have a value but no expected value to compare
                        }
                        
                        allMetadata.push({
                            field: key,
                            expected: expected,
                            actual: value || 'Not found',
                            status: status
                        });
                    }
                }
            }
            
            // Make sure we have sender_name and reply_address in the results
            const hasField = (field) => allMetadata.some(item => item.field === field || item.field === fieldNameMap[field]);
            
            // Get expected values from requirements metadata first, then form fields as fallback
            if (!hasField('sender_name')) {
                const expectedValue = metadataRequirements.sender_name || senderNameInput.value;
                if (expectedValue) {
                    allMetadata.push({
                        field: 'sender_name',
                        expected: expectedValue,
                        actual: 'Not found',
                        status: 'FAIL'
                    });
                }
            }
            
            if (!hasField('sender') && !hasField('sender_address')) {
                const expectedValue = metadataRequirements.sender_address || senderEmailInput.value;
                if (expectedValue) {
                    allMetadata.push({
                        field: 'sender_address',
                        expected: expectedValue,
                        actual: 'Not found',
                        status: 'FAIL'
                    });
                }
            }
            
            if (!hasField('reply_to') && !hasField('reply_address')) {
                const expectedValue = metadataRequirements.reply_address || replyEmailInput.value;
                if (expectedValue) {
                    allMetadata.push({
                        field: 'reply_address',
                        expected: expectedValue,
                        actual: 'Not found',
                        status: 'FAIL'
                    });
                }
            }
            
            // Make sure we have a campaign code field if one is specified in the requirements or form
            if (!hasField('campaign_code') && !hasField('footer_campaign_code')) {
                // Try different places for campaign code in priority order
                let expectedValue = metadataRequirements.footer_campaign_code || 
                                   metadataRequirements.campaign_code || 
                                   requirementsJSON.footer_campaign_code ||
                                   requirementsJSON.campaign_code || 
                                   campaignCodeInput.value;
                
                if (expectedValue) {
                    allMetadata.push({
                        field: 'campaign_code',
                        expected: expectedValue,
                        actual: 'Not found',
                        status: 'FAIL'
                    });
                }
            }
            
            // Display metadata results
            allMetadata.forEach(item => {
                const row = document.createElement('tr');
                
                const fieldCell = document.createElement('td');
                // Use the mapped field name if available, otherwise use the original field name
                fieldCell.textContent = fieldNameMap[item.field] || item.field;
                row.appendChild(fieldCell);
                
                const expectedCell = document.createElement('td');
                expectedCell.textContent = item.expected;
                row.appendChild(expectedCell);
                
                const actualCell = document.createElement('td');
                
                // Special handling for campaign_code display
                if ((item.field === 'campaign_code' || item.field === 'footer_campaign_code') && item.actual) {
                    // Make sure campaign code is fully visible and properly formatted
                    // Ensure it displays as "CODE - COUNTRY" if it contains a hyphen
                    let displayValue = item.actual;
                    
                    // Handle various campaign code formats and potential truncation issues
                    if (displayValue.includes(' - ')) {
                        const parts = displayValue.split(' - ');
                        if (parts.length === 2) {
                            const [code, country] = parts;
                            // Make sure both parts are fully displayed
                            displayValue = `${code} - ${country}`;
                        }
                    } else if (displayValue.includes('-')) {
                        // Handle case where there's no space around the hyphen
                        const parts = displayValue.split('-');
                        if (parts.length === 2) {
                            const [code, country] = parts;
                            // Add proper spacing
                            displayValue = `${code.trim()} - ${country.trim()}`;
                        }
                    } else if (displayValue.match(/^r?[A-Z0-9]{5,8}\s*[-]\s*[A-Z]{2}$/i)) {
                        // Handle cases where there's a leading 'r' or other character
                        // First explicitly remove 'r' prefix if present
                        if (displayValue.startsWith('r')) {
                            console.log("Removing 'r' prefix from campaign code in frontend:", displayValue);
                            displayValue = displayValue.substring(1);
                        }
                        
                        // Then extract and reformat to ensure proper format
                        const cleanMatch = displayValue.match(/([A-Z0-9]{5,8})\s*[-]\s*([A-Z]{2})/i);
                        if (cleanMatch) {
                            displayValue = `${cleanMatch[1]} - ${cleanMatch[2]}`;
                            console.log("Cleaned campaign code in frontend:", displayValue);
                        }
                    } else if (displayValue.toLowerCase().includes('upported')) {
                        // Fix for specific truncation issue with "Supported - Country" format
                        displayValue = displayValue.replace(/upported[\s-]*co/i, "Supported - CO");
                    } else if (displayValue.length < 5) {
                        // Handle very short truncated values
                        displayValue = `${displayValue} (Truncated)`;
                    }
                    
                    actualCell.textContent = displayValue;
                } else {
                    actualCell.textContent = item.actual;
                }
                
                if (item.details) {
                    const detailsElement = document.createElement('div');
                    detailsElement.innerHTML = `<em>${item.details}</em>`;
                    detailsElement.style.fontSize = 'smaller';
                    detailsElement.style.marginTop = '5px';
                    actualCell.appendChild(detailsElement);
                }
                
                row.appendChild(actualCell);
                
                const statusCell = document.createElement('td');
                statusCell.textContent = item.status;
                
                // Apply appropriate styling based on status
                if (item.status === 'PASS') {
                    statusCell.className = 'pass';
                } else if (item.status === 'FAIL') {
                    statusCell.className = 'fail';
                } else if (item.status === 'INFO') {
                    statusCell.className = 'info';
                    statusCell.style.color = '#4299e1'; // Blue for INFO status
                }
                
                row.appendChild(statusCell);
                
                metadataResults.appendChild(row);
            });
            
            // Process and display standalone images if available
            const imagesSection = document.getElementById('images-section');
            const imagesResults = document.getElementById('images-results');
            const imageWarningCount = document.getElementById('image-warning-count');
            
            // Clear previous results
            if (imagesResults) imagesResults.innerHTML = '';
            
            if (data.images && data.images.length > 0) {
                // Show the section
                if (imagesSection) imagesSection.style.display = 'block';
                
                // Display warning count if any
                if (imageWarningCount) {
                    if (data.image_warnings && data.image_warnings > 0) {
                        imageWarningCount.textContent = `${data.image_warnings} warning${data.image_warnings !== 1 ? 's' : ''}`;
                        imageWarningCount.style.display = 'inline-block';
                    } else {
                        imageWarningCount.style.display = 'none';
                    }
                }
                
                // Process each image
                data.images.forEach(image => {
                    const row = document.createElement('tr');
                    
                    // Image thumbnail cell
                    const imageCell = document.createElement('td');
                    if (image.src) {
                        const thumbnail = document.createElement('img');
                        thumbnail.src = image.src;
                        thumbnail.alt = image.alt || 'No alt text';
                        thumbnail.style.maxWidth = '120px';
                        thumbnail.style.maxHeight = '80px';
                        thumbnail.style.border = '1px solid #e2e8f0';
                        imageCell.appendChild(thumbnail);
                    } else {
                        imageCell.textContent = 'No image source';
                    }
                    row.appendChild(imageCell);
                    
                    // Alt text cell
                    const altTextCell = document.createElement('td');
                    if (image.has_alt) {
                        // Has alt text - display it normally
                        altTextCell.textContent = image.alt;
                    } else {
                        // No alt text - display warning
                        const altTextWarning = document.createElement('div');
                        altTextWarning.innerHTML = ' alt: none detected';
                        altTextWarning.style.color = '#e53e3e'; // Red for warning
                        altTextCell.appendChild(altTextWarning);
                    }
                    row.appendChild(altTextCell);
                    
                    // Status cell
                    const statusCell = document.createElement('td');
                    if (image.alt_warning) {
                        statusCell.textContent = 'Missing alt text';
                        statusCell.className = 'fail';
                    } else {
                        statusCell.textContent = 'OK';
                        statusCell.className = 'pass';
                    }
                    row.appendChild(statusCell);
                    
                    // Location cell
                    const locationCell = document.createElement('td');
                    locationCell.textContent = image.location || 'Unknown';
                    if (image.likely_purpose) {
                        const purposeSpan = document.createElement('div');
                        purposeSpan.textContent = image.likely_purpose;
                        purposeSpan.style.fontSize = '12px';
                        purposeSpan.style.color = '#718096';
                        purposeSpan.style.marginTop = '4px';
                        locationCell.appendChild(purposeSpan);
                    }
                    row.appendChild(locationCell);
                    
                    // Dimensions cell
                    const dimensionsCell = document.createElement('td');
                    if (image.width && image.height) {
                        dimensionsCell.textContent = `${image.width}  ${image.height}`;
                    } else {
                        dimensionsCell.textContent = 'Not specified';
                    }
                    row.appendChild(dimensionsCell);
                    
                    imagesResults.appendChild(row);
                });
            } else {
                // No images found - hide the section
                if (imagesSection) imagesSection.style.display = 'none';
            }
            
            // Display links results
            data.links.forEach(item => {
                const row = document.createElement('tr');
                
                // Link Source Cell
                const sourceCell = document.createElement('td');
                
                // Get the source text from various possible properties
                // The API might return different formats in different environments
                let sourceText = '';
                
                // Try different possible source properties in order of preference
                if (item.source) {
                    sourceText = item.source;
                } else if (item.link_source) {
                    sourceText = item.link_source;
                } else if (item.link_text) {
                    sourceText = item.link_text;
                }
                
                // Check if this looks like an image link by source text
                const isImageLink = (
                    (item.is_image_link) || 
                    (sourceText && sourceText.toLowerCase().includes('image')) || 
                    (item.link_source && item.link_source.toLowerCase().includes('image'))
                );
                
                // Get image info - try different properties based on API version
                const imageAlt = item.image_alt || 
                                (sourceText.includes('Image:') ? sourceText.split('Image:')[1].trim() : null);
                
                // Special case for header logo which almost always has an image
                const isLogo = (sourceText && sourceText.toLowerCase().includes('logo')) || 
                              (item.link_text && item.link_text.toLowerCase().includes('logo'));
                
                // For URLs linking to images
                const linksToImage = item.url && 
                                   (/\.(jpg|jpeg|png|gif|svg)($|\?)/).test(item.url.toLowerCase());
                
                // Helper to extract domain from URL for icon fallback
                function getDomainIcon(url) {
                    try {
                        const parsedUrl = new URL(url);
                        return `https://www.google.com/s2/favicons?domain=${parsedUrl.hostname}`;
                    } catch (e) {
                        return null;
                    }
                }
                
                // Determine if we should show image treatment
                if (isImageLink || isLogo || linksToImage || item.image_src) {
                    // Create a container for the thumbnail and text
                    const container = document.createElement('div');
                    container.style.display = 'flex';
                    container.style.alignItems = 'center';
                    container.style.gap = '8px';
                    
                    // Create thumbnail with progressive fallbacks
                    const thumbnail = document.createElement('img');
                    
                    // Use first available image source with fallbacks
                    if (item.image_src) {
                        thumbnail.src = item.image_src;
                    } else if (linksToImage) {
                        thumbnail.src = item.url;
                    } else if (isLogo) {
                        const domainIcon = getDomainIcon(item.url);
                        if (domainIcon) {
                            thumbnail.src = domainIcon;
                        } else {
                            thumbnail.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
                        }
                    } else {
                        thumbnail.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
                    }
                    
                    thumbnail.alt = imageAlt || 'Image';
                    thumbnail.style.maxWidth = '40px';
                    thumbnail.style.maxHeight = '40px';
                    thumbnail.style.border = '1px solid #e2e8f0';
                    thumbnail.style.borderRadius = '2px';
                    container.appendChild(thumbnail);
                    
                    // Add the link text or image alt
                    const textSpan = document.createElement('span');
                    
                    // Clean up the source text for display
                    let displayText = sourceText;
                    if (displayText && displayText.toLowerCase().startsWith('image:')) {
                        displayText = displayText.substring(6).trim();
                    }
                    
                    textSpan.textContent = imageAlt || displayText || '[Image]';
                    container.appendChild(textSpan);
                    
                    sourceCell.appendChild(container);
                    
                    // Add UTM content below the image and text
                    addUtmContentDisplay(sourceCell, item);
                } else {
                    // Create a container for the link text
                    const textContainer = document.createElement('div');
                    textContainer.textContent = sourceText || '[No text]';
                    sourceCell.appendChild(textContainer);
                    
                    // Add UTM content below the text
                    addUtmContentDisplay(sourceCell, item);
                }
                
                row.appendChild(sourceCell);
                
                // Original URL Cell
                const urlCell = document.createElement('td');
                urlCell.style.wordBreak = 'break-word'; // Allow URLs to wrap
                urlCell.style.maxWidth = '250px'; // Set a max width to encourage wrapping
                
                const link = document.createElement('a');
                link.href = item.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = item.url; // Display the full URL
                urlCell.appendChild(link);
                row.appendChild(urlCell);
                
                // Redirected URL Cell
                const redirectedCell = document.createElement('td');
                redirectedCell.classList.add('dev-mode-only'); // Add class for mode-based display
                redirectedCell.style.wordBreak = 'break-word'; // Allow URLs to wrap
                redirectedCell.style.maxWidth = '250px'; // Set a max width to encourage wrapping
                
                // Get the current application mode from the data
                const appMode = data.mode || 'production';  // Default to production if not specified
                
                // Apply appropriate mode class to container for CSS control
                if (appMode === 'production') {
                    document.querySelector('.container').classList.add('production-mode');
                } else {
                    document.querySelector('.container').classList.remove('production-mode');
                }
                
                // Add content to the cell regardless of mode (CSS will handle visibility)
                if (item.redirected_to) {
                    const redirectedLink = document.createElement('a');
                    redirectedLink.href = item.redirected_to;
                    redirectedLink.target = '_blank';
                    redirectedLink.rel = 'noopener noreferrer';
                    redirectedLink.textContent = item.redirected_to;
                    redirectedCell.appendChild(redirectedLink);
                    
                    // Add a visual indicator for localtest.me domains that were redirected
                    if (item.url.includes('localtest.me')) {
                        const localeIndicator = document.createElement('div');
                        localeIndicator.style.fontSize = '12px';
                        localeIndicator.style.marginTop = '4px';
                        localeIndicator.style.color = '#2b6cb0';
                        
                        // Determine locale from URL
                        const locale = item.url.includes('.mx.') || item.url.includes('.mx/') ? 'es-MX' : 'en';
                        localeIndicator.textContent = `Locale detected: ${locale}`;
                        redirectedCell.appendChild(localeIndicator);
                    }
                } else {
                    redirectedCell.textContent = 'N/A';
                }
                row.appendChild(redirectedCell);
                
                // Status Cell
                const statusCell = document.createElement('td');
                
                // Normalize status across environments
                let displayStatus = item.status || 'UNKNOWN';
                let displayHttpStatus = '';
                
                // Special case for partly-products-showcase URLs
                if (item.url && item.url.includes('partly-products-showcase.lovable.app')) {
                    // Get the current application mode
                    const appMode = data.mode || 'production';  // Default to production if not specified
                    const isProduction = appMode === 'production';
                    
                    displayStatus = 'PASS';
                    
                    // Use the http_status if available, otherwise show 200
                    if (item.http_status && typeof item.http_status === 'number') {
                        displayHttpStatus = item.http_status;
                    } else if (item.http_status) {
                        displayHttpStatus = item.http_status;
                    } else {
                        displayHttpStatus = 200;
                    }
                    
                    // Only add SIM indicator in development mode
                    if (!isProduction) {
                        displayHttpStatus = 'SIM';
                    }
                } else if (item.http_status) {
                    // For other URLs, show the actual HTTP status if available
                    displayHttpStatus = item.http_status;
                }
                
                // Format the status display
                if (displayHttpStatus) {
                    statusCell.textContent = `${displayStatus} (${displayHttpStatus})`;
                } else {
                    statusCell.textContent = displayStatus;
                }
                
                // Apply appropriate styling
                statusCell.className = displayStatus === 'PASS' ? 'pass' : 'fail';
                row.appendChild(statusCell);
                
                // Product Table Detection Cell
                const productTableCell = document.createElement('td');
                
                // Create a flex container for checkbox and status
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'flex-start';
                container.style.gap = '8px';
                
                // Create checkbox for product table detection
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'product-table-checkbox';
                checkbox.setAttribute('data-url', item.url);
                checkbox.style.marginTop = '3px'; // Align with text
                
                // Add checkbox to container
                container.appendChild(checkbox);
                
                // Create status container
                const statusContainer = document.createElement('div');
                statusContainer.className = 'product-table-status-container';
                statusContainer.style.flex = '1';
                
                // We want to start with "Not checked" by default, with a clean state
                // This ensures we don't show any old status from previous checks
                let hasProductTable = false;
                
                // Create status span
                const statusSpan = document.createElement('span');
                statusSpan.className = 'product-table-status';
                statusSpan.style.fontWeight = 'bold';
                
                // Default to "Not checked" 
                statusSpan.textContent = 'Not checked';
                statusSpan.style.color = '#718096'; // Gray
                
                // Only display product table status if it was explicitly checked and exists in the response
                if (item.product_table_checked === true) {
                    // If product table was found, update accordingly
                    if (item.has_product_table === true) {
                        hasProductTable = true;
                        statusSpan.textContent = 'Yes';
                        statusSpan.style.color = '#38a169'; // Green
                        row.style.backgroundColor = '#f0fff4'; // Light green background
                        
                        // Add class name if available
                        if (item.product_table_class) {
                            const classSpan = document.createElement('span');
                            classSpan.style.fontSize = '0.9em';
                            classSpan.style.display = 'block';
                            classSpan.style.color = '#718096'; // Gray
                            classSpan.textContent = `Class: ${item.product_table_class}`;
                            statusContainer.appendChild(classSpan);
                        }
                        
                        // Log for debugging
                        console.log("Product table found for URL: " + item.url);
                        if (item.product_table_class) {
                            console.log(`Found product table with class: ${item.product_table_class}`);
                        }
                    } else {
                        statusSpan.textContent = 'No';
                        statusSpan.style.color = '#4a5568'; // Gray
                    }
                    
                    // Show errors for any checked page
                    if (item.product_table_error) {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.fontSize = '12px';
                        errorDiv.style.marginTop = '4px';
                        errorDiv.style.color = '#e53e3e'; // Red
                        errorDiv.textContent = `Error: ${item.product_table_error}`;
                        statusContainer.appendChild(errorDiv);
                    }
                } else {
                    // Important: Only add error message if it's a "skip" error, not a failure error
                    if (item.product_table_error && item.product_table_error.includes("skipped")) {
                        const errorDiv = document.createElement('div');
                        errorDiv.style.fontSize = '12px';
                        errorDiv.style.marginTop = '4px';
                        errorDiv.style.color = '#718096'; // Gray for informational message
                        errorDiv.textContent = `Error: ${item.product_table_error}`;
                        statusContainer.appendChild(errorDiv);
                    }
                }
                
                // Add status span to container
                statusContainer.insertBefore(statusSpan, statusContainer.firstChild);
                
                // Add the status container to the main container
                container.appendChild(statusContainer);
                
                // Add the container to the cell
                productTableCell.appendChild(container);
                row.appendChild(productTableCell);
                
                // Issues Cell
                const issuesCell = document.createElement('td');
                if (item.utm_issues && item.utm_issues.length > 0) {
                    const issuesList = document.createElement('ul');
                    issuesList.style.paddingLeft = '20px';
                    
                    item.utm_issues.forEach(issue => {
                        const issueItem = document.createElement('li');
                        issueItem.textContent = issue;
                        issuesList.appendChild(issueItem);
                    });
                    
                    issuesCell.appendChild(issuesList);
                } else {
                    issuesCell.textContent = 'None';
                }
                row.appendChild(issuesCell);
                
                linksResults.appendChild(row);
            });
            
            // Show results
            showElement(resultsContainer);
        }
    </script>
</body>
</html>
